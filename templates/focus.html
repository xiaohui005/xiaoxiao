<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>关注点登记 - 彩票开奖数据分析系统</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/font-awesome-local.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/icons.css') }}" rel="stylesheet">
    <!-- 在<head>中引入select2样式（本地） -->
    <link href="{{ url_for('static', filename='css/select2.min.css') }}" rel="stylesheet" />
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            padding: 56px 48px;
            max-width: 1600px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }
        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .analysis-btn-group {
            gap: 12px 16px;
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }
        .analysis-btn-group .btn {
            min-width: 110px;
            font-size: 1.08rem;
            padding: 8px 18px;
            margin-bottom: 8px;
            border-radius: 22px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            transition: background 0.2s, color 0.2s;
        }
        .analysis-btn-group .btn.active, .analysis-btn-group .btn:active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
        }
        .analysis-stat-card {
            background: linear-gradient(135deg, #f8fafc 60%, #e9e4f0 100%);
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(102,126,234,0.08);
            padding: 18px 24px;
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 18px 32px;
            font-size: 1.15rem;
            align-items: center;
        }
        .analysis-stat-card .stat-item {
            min-width: 120px;
            font-weight: 600;
            color: #4b3fa7;
        }
        .analysis-table-wrap {
            margin-bottom: 24px;
            display: inline-block;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.12);
            padding: 18px 24px 12px 24px;
            min-width: 900px;
            max-width: 100%;
        }
        .analysis-table-wrap table {
            margin-bottom: 0;
            background: transparent;
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
        }
        .analysis-table-wrap th, .analysis-table-wrap td {
            text-align: center;
            font-size: 1.08rem;
            vertical-align: middle;
        }
        .analysis-table-wrap th {
            background: linear-gradient(90deg, #e9e4f0 60%, #f8fafc 100%);
            color: #4b3fa7;
            font-weight: bold;
            border-bottom: 2px solid #bdb6e0;
        }
        .analysis-table-wrap tr {
            transition: background 0.18s;
        }
        .analysis-table-wrap tbody tr:nth-child(even) {
            background: #f6f7fb;
        }
        .analysis-table-wrap tbody tr:hover {
            background: #e6eaff;
        }
        .analysis-table-wrap td {
            padding: 8px 10px;
        }
        .analysis-table-wrap .fw-bold.mb-2 {
            font-size: 1.13rem;
            color: #4b3fa7;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-star"></i> 关注点登记与分析</h1>
            <button class="btn btn-outline-primary mt-2" onclick="window.location.href='/'"><i class="fas fa-home"></i> 返回首页</button>
        </div>
        <!-- 标签页导航 -->
        <ul class="nav nav-tabs mb-4" id="focusTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-focus-register" data-bs-toggle="tab" data-bs-target="#focus-register" type="button" role="tab">登记关注点</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-bet-register" data-bs-toggle="tab" data-bs-target="#bet-register" type="button" role="tab">投注登记点</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-focus-result" data-bs-toggle="tab" data-bs-target="#focus-result" type="button" role="tab">关注点登记结果</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-focus-analysis" data-bs-toggle="tab" data-bs-target="#focus-analysis" type="button" role="tab">关注点分析</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-bet-report" data-bs-toggle="tab" data-bs-target="#bet-report" type="button" role="tab">投注点报表</button>
            </li>
        </ul>
        <!-- 标签页内容 -->
        <div class="tab-content" id="focusTabsContent">
            <!-- 登记关注点 -->
            <div class="tab-pane fade show active" id="focus-register" role="tabpanel">
                <div class="mb-3" id="focusSearchBar">
                    <form class="row gx-2 gy-1 align-items-end flex-nowrap" id="focusSearchForm" style="flex-wrap:nowrap;" onsubmit="return false;">
                        <div class="col-auto" style="min-width:160px;">
                            <label class="form-label">名称</label>
                            <input type="text" class="form-control" id="searchName" placeholder="模糊匹配">
                        </div>
                        <div class="col-auto" style="min-width:160px;">
                            <label class="form-label">描述</label>
                            <input type="text" class="form-control" id="searchDesc" placeholder="模糊匹配">
                        </div>
                        <div class="col-auto" style="min-width:160px;">
                            <label class="form-label">创建时间</label>
                            <input type="date" class="form-control" id="searchCreated">
                        </div>
                        <div class="col-auto" style="min-width:160px;">
                            <label class="form-label">更新时间</label>
                            <input type="date" class="form-control" id="searchUpdated">
                        </div>
                        <div class="col-auto d-flex align-items-end" style="min-width:120px;">
                            <button class="btn btn-primary me-2" id="btnSearch" type="button">查询</button>
                            <button class="btn btn-secondary" id="btnReset" type="button">重置</button>
                        </div>
                    </form>
                </div>
                <form id="focusForm" class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label">关注点名称</label>
                        <input type="text" class="form-control" id="focusName" required maxlength="100">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">描述</label>
                        <input type="text" class="form-control" id="focusDesc" maxlength="255">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100"><i class="fas fa-plus"></i> 登记</button>
                    </div>
                </form>
                <div id="focusList"></div>
            </div>
            <!-- 投注登记点 -->
            <div class="tab-pane fade" id="bet-register" role="tabpanel">
                <!-- 查询表单 -->
                <form class="row gx-2 gy-1 mb-2 align-items-end flex-wrap" id="betSearchForm" style="overflow-x:hidden;" onsubmit="return false;">
                    <div class="col-auto mb-1" style="min-width:120px;max-width:180px;">
                        <input type="text" class="form-control form-control-sm" id="betSearchPlace" placeholder="关注点">
                    </div>
                    <div class="col-auto mb-1" style="min-width:90px;max-width:130px;">
                        <input type="text" class="form-control form-control-sm" id="betSearchQishu" placeholder="期数">
                    </div>
                    <div class="col-auto mb-1" style="min-width:90px;max-width:130px;">
                        <input type="number" class="form-control form-control-sm" id="betSearchAmount" placeholder="金额">
                    </div>
                    <div class="col-auto mb-1" style="min-width:90px;max-width:130px;">
                        <input type="number" class="form-control form-control-sm" id="betSearchWin" placeholder="赢取">
                    </div>
                    <div class="col-auto mb-1" style="min-width:170px;max-width:220px;">
                        <div id="betSearchCorrectBtns" class="btn-group btn-group-sm" role="group" aria-label="对错">
                            <button type="button" class="btn btn-outline-secondary active" data-correct="">全部</button>
                            <button type="button" class="btn btn-outline-success" data-correct="1">正确</button>
                            <button type="button" class="btn btn-outline-danger" data-correct="0">错误</button>
                            <button type="button" class="btn btn-outline-dark" data-correct="-1">未判断</button>
                        </div>
                    </div>
                    <div class="col-12 col-md-auto mb-1" style="min-width:220px;max-width:320px;">
                        <div class="d-flex flex-row flex-md-nowrap align-items-center">
                            <input type="date" class="form-control form-control-sm me-1" style="max-width:120px;" id="betSearchCreatedStart" placeholder="开始时间">
                            <span style="font-size:13px;">-</span>
                            <input type="date" class="form-control form-control-sm ms-1" style="max-width:120px;" id="betSearchCreatedEnd" placeholder="结束时间">
                        </div>
                    </div>
                    <div class="col-12 col-md-auto mb-1" style="min-width:220px;max-width:320px;">
                        <div class="d-flex flex-row flex-md-nowrap align-items-center">
                            <input type="date" class="form-control form-control-sm me-1" style="max-width:120px;" id="betSearchUpdatedStart" placeholder="更新时间起">
                            <span style="font-size:13px;">-</span>
                            <input type="date" class="form-control form-control-sm ms-1" style="max-width:120px;" id="betSearchUpdatedEnd" placeholder="更新时间止">
                        </div>
                    </div>
                    <div class="col-12 col-md-auto d-flex align-items-end mb-1 mt-1 mt-md-0" style="min-width:100px;max-width:130px;">
                        <button class="btn btn-primary btn-sm me-1" id="betBtnSearch" type="button">查</button>
                        <button class="btn btn-secondary btn-sm" id="betBtnReset" type="button">重</button>
                    </div>
                </form>
                <form id="betForm" class="row g-3 mb-4 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">关注点</label>
                        <select class="form-select" id="betPlaceId" required></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">期数</label>
                        <input type="text" class="form-control" id="betQishu" required maxlength="20">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">投注金额</label>
                        <input type="number" class="form-control" id="betAmount" min="0" step="0.01" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">赢取金额</label>
                        <input type="number" class="form-control" id="winAmount" min="0" step="0.01">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">对错</label>
                        <div id="betIsCorrectBtns" class="btn-group btn-group-sm w-100" role="group" aria-label="对错">
                            <button type="button" class="btn btn-outline-secondary active" data-correct="">未判断</button>
                            <button type="button" class="btn btn-outline-success" data-correct="1">正确</button>
                            <button type="button" class="btn btn-outline-danger" data-correct="0">错误</button>
                        </div>
                        <input type="hidden" id="betIsCorrect" value="">
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100"><i class="fas fa-plus"></i> 登记</button>
                    </div>
                </form>
                <div id="betList"></div>
            </div>
            <!-- 关注点登记结果 -->
            <div class="tab-pane fade" id="focus-result" role="tabpanel">
                <!-- 关注点登记结果Tab下查询表单美化 -->
                <form class="row gx-4 gy-2 mb-3 align-items-end flex-wrap" id="placeResultSearchForm" style="overflow-x:hidden;padding:16px 0 8px 0;" onsubmit="return false;">
                    <div class="col-auto mb-2" style="min-width:220px;max-width:300px;margin-right:24px;">
                        <input type="text" class="form-control form-control-sm" id="resultSearchPlaceInput" placeholder="输入关注点名称" autocomplete="off" style="width:200px;">
                        <ul id="resultSearchPlaceSuggest" class="list-group position-absolute" style="z-index:1000;display:none;max-height:200px;overflow-y:auto;width:200px;"></ul>
                    </div>
                    <div class="col-auto mb-2" style="min-width:120px;max-width:180px;margin-right:24px;">
                        <input type="text" class="form-control form-control-sm" id="resultSearchQishu" placeholder="期数">
                    </div>
                    <div class="col-auto mb-2" style="min-width:200px;max-width:260px;margin-right:24px;">
                        <div id="resultSearchCorrectBtns" class="btn-group btn-group-sm" role="group" aria-label="对错">
                            <button type="button" class="btn btn-outline-secondary active" data-correct="">全部</button>
                            <button type="button" class="btn btn-outline-success" data-correct="1">正确</button>
                            <button type="button" class="btn btn-outline-danger" data-correct="0">错误</button>
                            <button type="button" class="btn btn-outline-dark" data-correct="-1">未判断</button>
                        </div>
                    </div>
                    <div class="col-auto d-flex align-items-end mb-2" style="min-width:140px;max-width:180px;margin-right:24px;">
                        <button class="btn btn-primary btn-sm me-2" id="resultBtnSearch" type="button">查</button>
                        <button class="btn btn-secondary btn-sm" id="resultBtnReset" type="button">重</button>
                    </div>
                </form>
                <!-- 新增登记关注点对错表单，关注点选择由下拉框改为按钮组 -->
                <div class="card mb-3 w-100" style="max-width:100%;">
                  <div class="card-body py-3">
                    <form id="addPlaceResultForm" class="row g-2 align-items-end">
                      <div class="col-12 mb-2">
                        <label class="form-label mb-1">关注点</label>
                        <div id="addPlaceResultPlaceBtns" class="btn-group btn-group-sm flex-wrap w-100" role="group" aria-label="关注点选择" style="width:100%;"></div>
                        <input type="hidden" id="addPlaceResultPlaceId" required>
                      </div>
                      <div class="col-md-5">
                        <label class="form-label mb-1">期数</label>
                        <input type="text" class="form-control form-control-sm" id="addPlaceResultQishu" required maxlength="20">
                      </div>
                      <div class="col-md-5">
                        <label class="form-label mb-1">对错</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="addPlaceResultIsCorrectRadio" id="addPlaceResultIsCorrectUnjudged" value="" checked>
                            <label class="form-check-label" for="addPlaceResultIsCorrectUnjudged">未判断</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="addPlaceResultIsCorrectRadio" id="addPlaceResultIsCorrectRight" value="1">
                            <label class="form-check-label" for="addPlaceResultIsCorrectRight">正确</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="addPlaceResultIsCorrectRadio" id="addPlaceResultIsCorrectWrong" value="0">
                            <label class="form-check-label" for="addPlaceResultIsCorrectWrong">错误</label>
                        </div>
                        <input type="hidden" id="addPlaceResultIsCorrect" value="">
                      </div>
                      <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success btn-sm w-100">登记</button>
                      </div>
                    </form>
                  </div>
                </div>
                <!-- 关注点登记结果Tab下新增登记表单 -->
                <div id="placeResultList"></div>
                <!-- 编辑对错模态框 -->
                <div class="modal fade" id="editPlaceResultModal" tabindex="-1" aria-labelledby="editPlaceResultModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="editPlaceResultModalLabel">编辑对错</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form id="editPlaceResultForm">
                          <input type="hidden" id="editPlaceResultId">
                          <div class="mb-3">
                            <label class="form-label">对错</label>
                            <div id="editPlaceResultCorrectBtns" class="btn-group btn-group-sm w-100" role="group" aria-label="对错">
                              <button type="button" class="btn btn-outline-secondary" data-correct="">未判断</button>
                              <button type="button" class="btn btn-outline-success" data-correct="1">正确</button>
                              <button type="button" class="btn btn-outline-danger" data-correct="0">错误</button>
                            </div>
                            <input type="hidden" id="editPlaceResultIsCorrect" value="">
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="saveEditPlaceResultBtn">保存</button>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
            <!-- 关注点分析Tab内容，关注点选择由下拉框改为按钮组 -->
            <div class="tab-pane fade" id="focus-analysis" role="tabpanel">
                <div class="mb-3">
                    <label class="form-label fw-bold" style="font-size:1.1rem;">选择关注点</label>
                    <div id="analysisPlaceBtns" class="btn-group flex-wrap analysis-btn-group" role="group" aria-label="关注点选择"></div>
                </div>
                <div id="analysisResult"></div>
            </div>
            <!-- 投注点报表 -->
            <div class="tab-pane fade" id="bet-report" role="tabpanel">
                <form class="row gx-2 gy-1 mb-3 align-items-end flex-wrap" id="betReportSearchForm" style="overflow-x:hidden;">
                    <div class="col-12 mb-2">
                        <label class="form-label mb-1">关注点</label>
                        <div id="betReportPlaceBtns" class="btn-group btn-group-sm flex-wrap w-100" role="group" aria-label="关注点选择"></div>
                        <input type="hidden" id="betReportPlaceId">
                    </div>
                    <div class="col-auto mb-1" style="min-width:180px;max-width:240px;">
                        <label class="form-label mb-1">对错</label>
                        <div id="betReportIsCorrectBtns" class="btn-group btn-group-sm w-100" role="group" aria-label="对错">
                            <button type="button" class="btn btn-outline-secondary active" data-correct="">全部</button>
                            <button type="button" class="btn btn-outline-success" data-correct="1">正确</button>
                            <button type="button" class="btn btn-outline-danger" data-correct="0">错误</button>
                            <button type="button" class="btn btn-outline-dark" data-correct="-1">未判断</button>
                        </div>
                    </div>
                    <div class="col-auto mb-1" style="min-width:220px;max-width:320px;">
                        <label class="form-label mb-1">投注时间</label>
                        <div class="d-flex flex-row flex-nowrap align-items-center">
                            <input type="date" class="form-control form-control-sm me-1" id="betReportStartDate" style="max-width:120px;">
                            <span style="font-size:13px;">-</span>
                            <input type="date" class="form-control form-control-sm ms-1" id="betReportEndDate" style="max-width:120px;">
                        </div>
                    </div>
                    <div class="col-auto mb-1 d-flex align-items-end">
                        <button class="btn btn-primary btn-sm me-2" id="betReportBtnSearch" type="button">查询</button>
                        <button class="btn btn-secondary btn-sm" id="betReportBtnReset" type="button">重置</button>
                    </div>
                </form>
                <div id="betReportStats"></div>
                <div id="betReportTable"></div>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // 关注点API交互
        let allPlacesCache = [];
        async function fetchPlaces() {
            const resp = await fetch('/api/places');
            const result = await resp.json();
            if (result.success) return result.data;
            return [];
        }
        async function addPlace(name, description) {
            const resp = await fetch('/api/places', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description })
            });
            return await resp.json();
        }
        async function deletePlace(id) {
            const resp = await fetch(`/api/places/${id}`, { method: 'DELETE' });
            return await resp.json();
        }
        // 渲染关注点列表，支持前端过滤
        async function renderFocusList() {
            if (!allPlacesCache.length) allPlacesCache = await fetchPlaces();
            let list = allPlacesCache;
            // 获取查询条件
            const name = document.getElementById('searchName')?.value.trim();
            const desc = document.getElementById('searchDesc')?.value.trim();
            const created = document.getElementById('searchCreated')?.value;
            const updated = document.getElementById('searchUpdated')?.value;
            // 过滤
            if (name) list = list.filter(item => item.name && item.name.includes(name));
            if (desc) list = list.filter(item => item.description && item.description.includes(desc));
            if (created) list = list.filter(item => item.created_at && item.created_at.slice(0,10) === created);
            if (updated) list = list.filter(item => item.updated_at && item.updated_at.slice(0,10) === updated);
            let html = '';
            if (!list.length) {
                html = '<div class="alert alert-info">暂无关注点，请登记。</div>';
            } else {
                html = '<table class="table table-bordered table-sm table-hover"><thead><tr><th>ID</th><th>名称</th><th>描述</th><th>创建时间</th><th>更新时间</th><th>操作</th></tr></thead><tbody>';
                list.forEach(item => {
                    html += `<tr>`;
                    html += `<td>${item.id}</td>`;
                    html += `<td>${item.name}</td>`;
                    html += `<td>${item.description||''}</td>`;
                    html += `<td>${item.created_at ? item.created_at.substring(0,10) : ''}</td>`;
                    html += `<td>${item.updated_at ? item.updated_at.substring(0,10) : ''}</td>`;
                    html += `<td>`;
                    html += `<button class='btn btn-primary btn-sm me-1' onclick='onEditPlace(${item.id})'>编辑</button>`;
                    html += `<button class='btn btn-danger btn-sm' onclick='onDeletePlace(${item.id})'>删除</button>`;
                    html += `</td>`;
                    html += `</tr>`;
                });
                html += '</tbody></table>';
            }
            document.getElementById('focusList').innerHTML = html;
        }
        async function onDeletePlace(id) {
            if (!confirm('确定要删除该关注点吗？')) return;
            await deletePlace(id);
            refreshPlacesCacheAndRender();
        }
        // 查询和重置按钮事件
        document.getElementById('btnSearch').onclick = function() {
            renderFocusList();
        };
        document.getElementById('btnReset').onclick = function() {
            document.getElementById('focusSearchForm').reset();
            renderFocusList();
        };
        // 新增：每次增删后刷新缓存
        async function refreshPlacesCacheAndRender() {
            allPlacesCache = await fetchPlaces();
            renderFocusList();
        }
        document.getElementById('focusForm').onsubmit = async function(e) {
            e.preventDefault();
            const name = document.getElementById('focusName').value.trim();
            const desc = document.getElementById('focusDesc').value.trim();
            if (!name) return alert('名称不能为空');
            const res = await addPlace(name, desc);
            if (res.success) {
                this.reset();
                refreshPlacesCacheAndRender();
                await renderBetPlaceOptions(); // 新增后刷新下拉框
            } else {
                alert(res.error || '添加失败');
            }
        };
        document.addEventListener('DOMContentLoaded', async function() {
            allPlacesCache = await fetchPlaces();
            renderFocusList();
            // 绑定保存按钮事件（编辑关注点）
            const saveEditPlaceBtn = document.getElementById('saveEditPlaceBtn');
            if (saveEditPlaceBtn) {
                saveEditPlaceBtn.onclick = async function() {
                    const id = document.getElementById('editPlaceId').value;
                    const name = document.getElementById('editPlaceName').value.trim();
                    const desc = document.getElementById('editPlaceDesc').value.trim();
                    if (!name) return alert('名称不能为空');
                    // 调用API
                    const resp = await fetch(`/api/places/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description: desc })
                    });
                    const result = await resp.json();
                    if (result.success) {
                        // 关闭模态框
                        bootstrap.Modal.getInstance(document.getElementById('editPlaceModal')).hide();
                        refreshPlacesCacheAndRender();
                    } else {
                        alert(result.error || '保存失败');
                    }
                };
            }
        });
    </script>
    <!-- 编辑模态框 -->
    <div class="modal fade" id="editPlaceModal" tabindex="-1" aria-labelledby="editPlaceModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editPlaceModalLabel">编辑关注点</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editPlaceForm">
              <input type="hidden" id="editPlaceId">
              <div class="mb-3">
                <label for="editPlaceName" class="form-label">名称</label>
                <input type="text" class="form-control" id="editPlaceName" maxlength="100" required>
              </div>
              <div class="mb-3">
                <label for="editPlaceDesc" class="form-label">描述</label>
                <input type="text" class="form-control" id="editPlaceDesc" maxlength="255">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="saveEditPlaceBtn">保存</button>
          </div>
        </div>
      </div>
    </div>
    <script>
    async function onEditPlace(id) {
        // 获取数据
        const place = allPlacesCache.find(p => p.id === id);
        if (!place) return alert('未找到该关注点');
        document.getElementById('editPlaceId').value = place.id;
        document.getElementById('editPlaceName').value = place.name;
        document.getElementById('editPlaceDesc').value = place.description || '';
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('editPlaceModal'));
        modal.show();
    }
    // 投注点API交互
    async function fetchBets(place_id) {
        let url = '/api/bets';
        if (place_id) url += `?place_id=${place_id}`;
        const resp = await fetch(url);
        const result = await resp.json();
        if (result.success) return result.data;
        return [];
    }
    async function addBet(data) {
        const resp = await fetch('/api/bets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        return await resp.json();
    }
    async function deleteBet(id) {
        const resp = await fetch(`/api/bets/${id}`, { method: 'DELETE' });
        return await resp.json();
    }
    async function updateBet(id, data) {
        const resp = await fetch(`/api/bets/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        return await resp.json();
    }
    // 渲染投注点下拉
    async function renderBetPlaceOptions() {
        allPlacesCache = await fetchPlaces();
        const sel = document.getElementById('betPlaceId');
        sel.innerHTML = '<option value="">请选择关注点</option>' + allPlacesCache.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    // 分页参数
    let betListPage = 1;
    let betListPageSize = 50;
    // 渲染投注记录列表
    let allBetsCache = [];
    async function renderBetList(page) {
        page = page || betListPage;
        const placeId = document.getElementById('betPlaceId').value;
        allBetsCache = await fetchBets(placeId);
        // 读取查询条件
        const searchPlace = document.getElementById('betSearchPlace')?.value.trim();
        const searchQishu = document.getElementById('betSearchQishu')?.value.trim();
        const searchAmount = document.getElementById('betSearchAmount')?.value;
        const searchWin = document.getElementById('betSearchWin')?.value;
        let searchCorrect = '';
        const correctBtns = document.getElementById('betSearchCorrectBtns');
        if (correctBtns) {
            const activeBtn = correctBtns.querySelector('button.active');
            if (activeBtn) searchCorrect = activeBtn.getAttribute('data-correct');
        }
        const searchCreatedStart = document.getElementById('betSearchCreatedStart')?.value;
        const searchCreatedEnd = document.getElementById('betSearchCreatedEnd')?.value;
        const searchUpdatedStart = document.getElementById('betSearchUpdatedStart')?.value;
        const searchUpdatedEnd = document.getElementById('betSearchUpdatedEnd')?.value;
        let list = allBetsCache;
        if (searchPlace) {
            list = list.filter(item => {
                const place = allPlacesCache.find(p => p.id === item.place_id);
                return place && place.name && place.name.includes(searchPlace);
            });
        }
        if (searchQishu) list = list.filter(item => item.qishu && item.qishu.includes(searchQishu));
        if (searchAmount) list = list.filter(item => Number(item.bet_amount) == Number(searchAmount));
        if (searchWin) list = list.filter(item => Number(item.win_amount) == Number(searchWin));
        if (searchCorrect === '1' || searchCorrect === '0') {
            list = list.filter(item => String(item.is_correct) === searchCorrect);
        } else if (searchCorrect === '-1') {
            list = list.filter(item => item.is_correct === '' || item.is_correct === null);
        }
        if (searchCreatedStart) list = list.filter(item => item.created_at && item.created_at.slice(0,10) >= searchCreatedStart);
        if (searchCreatedEnd) list = list.filter(item => item.created_at && item.created_at.slice(0,10) <= searchCreatedEnd);
        if (searchUpdatedStart) list = list.filter(item => item.updated_at && item.updated_at.slice(0,10) >= searchUpdatedStart);
        if (searchUpdatedEnd) list = list.filter(item => item.updated_at && item.updated_at.slice(0,10) <= searchUpdatedEnd);
        // 按期数倒序排列
        list = list.sort((a, b) => (b.qishu || '').localeCompare(a.qishu || ''));
        // 统计
        let totalBet = 0, totalWin = 0, totalWinlose = 0;
        let pageBet = 0, pageWin = 0, pageWinlose = 0;
        list.forEach(item => {
            totalBet += Number(item.bet_amount) || 0;
            totalWin += Number(item.win_amount) || 0;
            let winlose = 0;
            if (item.is_correct === 1 || item.is_correct === 0) {
                winlose = (Number(item.win_amount) || 0) - (Number(item.bet_amount) || 0);
            }
            totalWinlose += (item.is_correct === '' || item.is_correct === null) ? 0 : winlose;
        });
        // 分页
        const totalPage = Math.ceil(list.length / betListPageSize) || 1;
        if (page > totalPage) page = totalPage;
        betListPage = page;
        const startIdx = (page - 1) * betListPageSize;
        const endIdx = startIdx + betListPageSize;
        const pageList = list.slice(startIdx, endIdx);
        // 本页统计
        pageList.forEach(item => {
            pageBet += Number(item.bet_amount) || 0;
            pageWin += Number(item.win_amount) || 0;
            let winlose = 0;
            if (item.is_correct === 1 || item.is_correct === 0) {
                winlose = (Number(item.win_amount) || 0) - (Number(item.bet_amount) || 0);
            }
            pageWinlose += (item.is_correct === '' || item.is_correct === null) ? 0 : winlose;
        });
        let html = '';
        if (!list.length) {
            html = '<div class="alert alert-info">暂无投注记录。</div>';
        } else {
            html = '<table class="table table-bordered table-sm table-hover"><thead><tr><th>ID</th><th>关注点</th><th>期数</th><th>投注金额</th><th>赢取金额</th><th>对错</th><th>输赢</th><th>创建时间</th><th>更新时间</th><th>操作</th></tr></thead><tbody>';
            pageList.forEach(item => {
                const place = allPlacesCache.find(p => p.id === item.place_id);
                let winlose = 0;
                if (item.is_correct === 1 || item.is_correct === 0) {
                    winlose = (Number(item.win_amount) || 0) - (Number(item.bet_amount) || 0);
                }
                html += `<tr>`;
                html += `<td>${item.id}</td>`;
                html += `<td>${place ? place.name : item.place_id}</td>`;
                html += `<td>${item.qishu}</td>`;
                html += `<td>${item.bet_amount}</td>`;
                html += `<td>${item.win_amount}</td>`;
                html += `<td>${item.is_correct === 1 ? '正确' : (item.is_correct === 0 ? '错误' : '未判断')}</td>`;
                html += `<td>${item.is_correct === '' || item.is_correct === null ? 0 : winlose}</td>`;
                html += `<td>${item.created_at || ''}</td>`;
                html += `<td>${item.updated_at || ''}</td>`;
                html += `<td>`;
                html += `<button class='btn btn-primary btn-sm me-1' onclick='onEditBet(${item.id})'>编辑</button>`;
                html += `<button class='btn btn-danger btn-sm' onclick='onDeleteBet(${item.id})'>删除</button>`;
                html += `</td>`;
                html += `</tr>`;
            });
            // 统计行
            html += `<tr class='table-info fw-bold'><td colspan='3'>本页统计</td><td>${pageBet}</td><td>${pageWin}</td><td></td><td>${pageWinlose}</td><td colspan='2'></td></tr>`;
            html += `<tr class='table-warning fw-bold'><td colspan='3'>总统计</td><td>${totalBet}</td><td>${totalWin}</td><td></td><td>${totalWinlose}</td><td colspan='2'></td></tr>`;
            html += '</tbody></table>';
            // 分页控件
            html += `<div class='d-flex justify-content-center align-items-center flex-wrap'>`;
            html += `<nav><ul class='pagination pagination-sm mb-0'>`;
            for(let i=1;i<=totalPage;i++){
                html += `<li class='page-item${i===page?' active':''}'><a class='page-link' href='javascript:void(0)' onclick='renderBetList(${i})'>${i}</a></li>`;
            }
            html += `</ul></nav>`;
            html += `<div class='ms-3' style='min-width:220px;max-width:300px;'><label class='form-label mb-0 me-1' style='font-size:13px;'>每页</label><div id='betPageSizeBtns' class='btn-group btn-group-sm' role='group' aria-label='每页条数'><button type='button' class='btn btn-outline-primary' data-size='10'>10</button><button type='button' class='btn btn-outline-primary${betListPageSize===50?' active':''}' data-size='50'>50</button><button type='button' class='btn btn-outline-primary' data-size='100'>100</button><button type='button' class='btn btn-outline-primary' data-size='500'>500</button><button type='button' class='btn btn-outline-primary' data-size='1000'>1000</button></div></div>`;
            html += `</div>`;
        }
        document.getElementById('betList').innerHTML = html;
    }
    // 投注登记表单提交
    document.getElementById('betForm').onsubmit = async function(e) {
        e.preventDefault();
        const place_id = document.getElementById('betPlaceId').value;
        const qishu = document.getElementById('betQishu').value.trim();
        const bet_amount = parseFloat(document.getElementById('betAmount').value) || 0;
        const win_amount = parseFloat(document.getElementById('winAmount').value) || 0;
        const is_correct = document.getElementById('betIsCorrect').value;
        if (!place_id || !qishu) return alert('关注点和期数为必填项');
        const res = await addBet({ place_id, qishu, bet_amount, win_amount, is_correct: is_correct === '' ? null : Number(is_correct) });
        if (res.success) {
            this.reset();
            await renderBetPlaceOptions(); // 新增后刷新下拉框
            renderBetList();
        } else {
            alert(res.error || '添加失败');
        }
    };
    // 删除投注
    async function onDeleteBet(id) {
        if (!confirm('确定要删除该投注记录吗？')) return;
        await deleteBet(id);
        renderBetList();
    }
    // 编辑投注弹窗
    let editingBetId = null;
    async function onEditBet(id) {
        const bet = allBetsCache.find(b => b.id === id);
        if (!bet) return alert('未找到该投注记录');
        editingBetId = id;
        // 填充关注点下拉
        const placeSel = document.getElementById('editBetPlaceId');
        placeSel.innerHTML = allPlacesCache.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        placeSel.value = bet.place_id;
        placeSel.disabled = true; // 禁用关注点
        // 填充期数
        const qishuInput = document.getElementById('editBetQishu');
        qishuInput.value = bet.qishu;
        qishuInput.disabled = true; // 禁用期数
        document.getElementById('editBetAmount').value = bet.bet_amount;
        document.getElementById('editWinAmount').value = bet.win_amount;
        // 设置对错按钮组
        const editBtns = document.getElementById('editBetIsCorrectBtns');
        if (editBtns) {
            editBtns.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
                if ((btn.getAttribute('data-correct') === '' && (bet.is_correct === null || bet.is_correct === '')) || btn.getAttribute('data-correct') === String(bet.is_correct)) {
                    btn.classList.add('active');
                }
                // 绑定点击事件，确保每次都能切换active并同步input
                btn.onclick = function() {
                    editBtns.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('editBetIsCorrect').value = this.getAttribute('data-correct');
                };
            });
        }
        document.getElementById('editBetIsCorrect').value = bet.is_correct === null ? '' : String(bet.is_correct);
        const modal = new bootstrap.Modal(document.getElementById('editBetModal'));
        modal.show();
    }
    document.addEventListener('DOMContentLoaded', async function() {
        allPlacesCache = await fetchPlaces();
        renderFocusList();
        // 绑定保存按钮事件（编辑关注点）
        const saveEditPlaceBtn = document.getElementById('saveEditPlaceBtn');
        if (saveEditPlaceBtn) {
            saveEditPlaceBtn.onclick = async function() {
                const id = document.getElementById('editPlaceId').value;
                const name = document.getElementById('editPlaceName').value.trim();
                const desc = document.getElementById('editPlaceDesc').value.trim();
                if (!name) return alert('名称不能为空');
                // 调用API
                const resp = await fetch(`/api/places/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description: desc })
                });
                const result = await resp.json();
                if (result.success) {
                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('editPlaceModal')).hide();
                    refreshPlacesCacheAndRender();
                } else {
                    alert(result.error || '保存失败');
                }
            };
        }
        // 绑定保存按钮事件（编辑投注记录）
        const saveEditBetBtn = document.getElementById('saveEditBetBtn');
        if (saveEditBetBtn) {
            saveEditBetBtn.onclick = async function() {
                const id = editingBetId;
                const bet_amount_raw = document.getElementById('editBetAmount').value;
                const win_amount_raw = document.getElementById('editWinAmount').value;
                const is_correct_raw = document.getElementById('editBetIsCorrect').value;
                const bet_amount = bet_amount_raw === '' ? null : Number(bet_amount_raw);
                const win_amount = win_amount_raw === '' ? null : Number(win_amount_raw);
                const is_correct = is_correct_raw === '' ? null : Number(is_correct_raw);
                if (!id) return alert('ID丢失');
                const res = await updateBet(id, { bet_amount, win_amount, is_correct });
                if (res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editBetModal')).hide();
                    renderBetList();
                } else {
                    alert(res.error || '保存失败');
                }
            };
        }
        // 绑定投注查询和重置按钮事件
        const betBtnSearch = document.getElementById('betBtnSearch');
        if (betBtnSearch) {
            betBtnSearch.onclick = function() {
                renderBetList();
            };
        }
        const betBtnReset = document.getElementById('betBtnReset');
        if (betBtnReset) {
            betBtnReset.onclick = function() {
                document.getElementById('betSearchForm').reset();
                renderBetList();
            };
        }
        // 绑定每页条数按钮事件（表格渲染后动态绑定）
        window.addEventListener('click', function(e) {
            if (e.target && e.target.closest && e.target.closest('#betPageSizeBtns')) {
                const btn = e.target.closest('button[data-size]');
                if (btn) {
                    const group = btn.parentElement;
                    group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    betListPageSize = parseInt(btn.getAttribute('data-size'), 10);
                    betListPage = 1;
                    renderBetList(1);
                }
            }
        });
        // 绑定对错按钮事件
        const betSearchCorrectBtns = document.getElementById('betSearchCorrectBtns');
        if (betSearchCorrectBtns) {
            betSearchCorrectBtns.querySelectorAll('button').forEach(btn => {
                btn.onclick = function() {
                    betSearchCorrectBtns.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    renderBetList(1);
                };
            });
        }
        // 绑定投注登记表单对错按钮事件
        const betIsCorrectBtns = document.getElementById('betIsCorrectBtns');
        if (betIsCorrectBtns) {
            betIsCorrectBtns.querySelectorAll('button').forEach(btn => {
                btn.onclick = function() {
                    betIsCorrectBtns.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('betIsCorrect').value = this.getAttribute('data-correct');
                };
            });
        }
        // 初始化投注点Tab
        document.getElementById('tab-bet-register').addEventListener('click', async function() {
            await renderBetPlaceOptions();
            renderBetList();
        });
    });
    </script>
    <!-- 编辑投注模态框 -->
    <div class="modal fade" id="editBetModal" tabindex="-1" aria-labelledby="editBetModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editBetModalLabel">编辑投注记录</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editBetForm">
              <div class="mb-3">
                <label class="form-label">关注点</label>
                <select class="form-select" id="editBetPlaceId">
                  <option value="">请选择关注点</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">期数</label>
                <input type="text" class="form-control" id="editBetQishu">
              </div>
              <div class="mb-3">
                <label class="form-label">投注金额</label>
                <input type="number" class="form-control" id="editBetAmount" min="0" step="0.01">
              </div>
              <div class="mb-3">
                <label class="form-label">赢取金额</label>
                <input type="number" class="form-control" id="editWinAmount" min="0" step="0.01">
              </div>
              <div class="mb-3">
                <label class="form-label">对错</label>
                <div id="editBetIsCorrectBtns" class="btn-group btn-group-sm w-100" role="group" aria-label="对错">
                    <button type="button" class="btn btn-outline-secondary" data-correct="">未判断</button>
                    <button type="button" class="btn btn-outline-success" data-correct="1">正确</button>
                    <button type="button" class="btn btn-outline-danger" data-correct="0">错误</button>
                </div>
                <input type="hidden" id="editBetIsCorrect" value="">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="saveEditBetBtn">保存</button>
          </div>
        </div>
      </div>
    </div>
    <script>
    <!-- 关注点登记结果API -->
    async function fetchPlaceResults(params={}) {
        const url = new URL('/api/place-results', window.location.origin);
        Object.entries(params).forEach(([k,v])=>{ if(v!==''&&v!==null&&v!==undefined) url.searchParams.append(k,v); });
        const resp = await fetch(url);
        const result = await resp.json();
        if (result.success) return result.data;
        return [];
    }
    async function updatePlaceResult(id, is_correct) {
        const resp = await fetch(`/api/place-results/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_correct })
        });
        return await resp.json();
    }
    async function deletePlaceResult(id) {
        const resp = await fetch(`/api/place-results/${id}`, { method: 'DELETE' });
        return await resp.json();
    }
    // 渲染关注点结果下拉（已废弃）
    // function renderResultPlaceOptions() { ... }
    // 新：模糊输入关注点名称自动提示
    function setupResultPlaceInput() {
        const input = document.getElementById('resultSearchPlaceInput');
        const suggest = document.getElementById('resultSearchPlaceSuggest');
        input.addEventListener('input', function() {
            const val = input.value.trim().toLowerCase();
            if (!val) {
                suggest.style.display = 'none';
                suggest.innerHTML = '';
                return;
            }
            const matches = allPlacesCache.filter(p => p.name && p.name.toLowerCase().includes(val));
            if (!matches.length) {
                suggest.style.display = 'none';
                suggest.innerHTML = '';
                return;
            }
            suggest.innerHTML = matches.map(p => `<li class='list-group-item list-group-item-action' data-id='${p.id}'>${p.name}</li>`).join('');
            suggest.style.display = 'block';
        });
        // 选择建议
        suggest.addEventListener('click', function(e) {
            if (e.target && e.target.matches('li[data-id]')) {
                input.value = e.target.textContent;
                input.dataset.placeId = e.target.getAttribute('data-id');
                suggest.style.display = 'none';
                renderPlaceResultList(1);
            }
        });
        // 失去焦点隐藏建议
        input.addEventListener('blur', function() {
            setTimeout(()=>{suggest.style.display = 'none';}, 200);
        });
        // 清除placeId
        input.addEventListener('focus', function() {
            input.dataset.placeId = '';
        });
    }
    // 渲染新增登记关注点按钮组，仅此处用接口，其它地方不变
    async function renderAddPlaceResultPlaceBtns() {
      const resp = await fetch('/api/places/simple');
      const result = await resp.json();
      if (!result.success) return;
      const places = result.data;
      const btns = places.map((p, idx) =>
        `<button type='button' class='btn btn-outline-primary${idx===0?' active':''}' data-id='${p.id}'>${p.name}</button>`
      ).join('');
      document.getElementById('addPlaceResultPlaceBtns').innerHTML = btns;
      // 默认选中第一个
      const first = document.querySelector('#addPlaceResultPlaceBtns button');
      if (first) {
        document.getElementById('addPlaceResultPlaceId').value = first.getAttribute('data-id');
      }
      // 绑定点击事件
      document.querySelectorAll('#addPlaceResultPlaceBtns button').forEach(btn => {
        btn.onclick = function() {
          document.querySelectorAll('#addPlaceResultPlaceBtns button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('addPlaceResultPlaceId').value = this.getAttribute('data-id');
        };
      });
    }
    // 渲染关注点结果列表
    let placeResultPage = 1;
    let placeResultPageSize = 50;
    let allPlaceResultsCache = [];
    async function renderPlaceResultList(page) {
        page = page || placeResultPage;
        // 获取筛选条件
        const placeInput = document.getElementById('resultSearchPlaceInput');
        const place_id = placeInput.dataset.placeId || '';
        const qishu = document.getElementById('resultSearchQishu').value.trim();
        let searchCorrect = '';
        const correctBtns = document.getElementById('resultSearchCorrectBtns');
        if (correctBtns) {
            const activeBtn = correctBtns.querySelector('button.active');
            if (activeBtn) searchCorrect = activeBtn.getAttribute('data-correct');
        }
        let is_correct = '';
        if (searchCorrect === '1' || searchCorrect === '0') is_correct = searchCorrect;
        else if (searchCorrect === '-1') is_correct = null;
        // 获取数据
        allPlaceResultsCache = await fetchPlaceResults({ place_id, qishu, is_correct });
        // 前端再做期数倒序
        let list = allPlaceResultsCache.sort((a,b)=>(b.qishu||'').localeCompare(a.qishu||''));
        // 分页
        const totalPage = Math.ceil(list.length / placeResultPageSize) || 1;
        if (page > totalPage) page = totalPage;
        placeResultPage = page;
        const startIdx = (page - 1) * placeResultPageSize;
        const endIdx = startIdx + placeResultPageSize;
        const pageList = list.slice(startIdx, endIdx);
        let html = '';
        if (!list.length) {
            html = '<div class="alert alert-info">暂无关注点登记结果。</div>';
        } else {
            html = '<table class="table table-bordered table-sm table-hover"><thead><tr><th>ID</th><th>关注点</th><th>期数</th><th>对错</th><th>创建时间</th><th>更新时间</th><th>操作</th></tr></thead><tbody>';
            pageList.forEach(item => {
                const place = allPlacesCache.find(p => p.id === item.place_id);
                html += `<tr>`;
                html += `<td>${item.id}</td>`;
                html += `<td>${place ? place.name : item.place_id}</td>`;
                html += `<td>${item.qishu}</td>`;
                html += `<td>${item.is_correct === 1 ? '正确' : (item.is_correct === 0 ? '错误' : '未判断')}</td>`;
                html += `<td>${item.created_at || ''}</td>`;
                html += `<td>${item.updated_at || ''}</td>`;
                html += `<td>`;
                html += `<button class='btn btn-primary btn-sm me-1' onclick='onEditPlaceResult(${item.id})'>编辑</button>`;
                html += `<button class='btn btn-danger btn-sm' onclick='onDeletePlaceResult(${item.id})'>删除</button>`;
                html += `</td>`;
                html += `</tr>`;
            });
            html += '</tbody></table>';
            // 分页控件
            html += `<div class='d-flex justify-content-center align-items-center flex-wrap'>`;
            html += `<nav><ul class='pagination pagination-sm mb-0'>`;
            for(let i=1;i<=totalPage;i++){
                html += `<li class='page-item${i===page?' active':''}'><a class='page-link' href='javascript:void(0)' onclick='renderPlaceResultList(${i})'>${i}</a></li>`;
            }
            html += `</ul></nav>`;
            html += `<div class='ms-3' style='min-width:220px;max-width:300px;'><label class='form-label mb-0 me-1' style='font-size:13px;'>每页</label><div id='placeResultPageSizeBtns' class='btn-group btn-group-sm' role='group' aria-label='每页条数'><button type='button' class='btn btn-outline-primary' data-size='10'>10</button><button type='button' class='btn btn-outline-primary${placeResultPageSize===50?' active':''}' data-size='50'>50</button><button type='button' class='btn btn-outline-primary' data-size='100'>100</button><button type='button' class='btn btn-outline-primary' data-size='500'>500</button><button type='button' class='btn btn-outline-primary' data-size='1000'>1000</button></div></div>`;
            html += `</div>`;
        }
        document.getElementById('placeResultList').innerHTML = html;
    }
    // 编辑对错弹窗
    let editingPlaceResultId = null;
    async function onEditPlaceResult(id) {
        const item = allPlaceResultsCache.find(r => r.id === id);
        if (!item) return alert('未找到该记录');
        editingPlaceResultId = id;
        // 设置按钮组
        const editBtns = document.getElementById('editPlaceResultCorrectBtns');
        if (editBtns) {
            editBtns.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
                if ((btn.getAttribute('data-correct') === '' && (item.is_correct === null || item.is_correct === '')) || btn.getAttribute('data-correct') === String(item.is_correct)) {
                    btn.classList.add('active');
                }
            });
        }
        document.getElementById('editPlaceResultIsCorrect').value = item.is_correct === null ? '' : String(item.is_correct);
        const modal = new bootstrap.Modal(document.getElementById('editPlaceResultModal'));
        modal.show();
    }
    // 删除
    async function onDeletePlaceResult(id) {
        if (!confirm('确定要删除该记录吗？')) return;
        await deletePlaceResult(id);
        renderPlaceResultList();
    }
    document.addEventListener('DOMContentLoaded', function() {
        // 关注点结果Tab初始化
        document.getElementById('tab-focus-result').addEventListener('click', function() {
            setupResultPlaceInput(); // 确保每次切换Tab都初始化输入提示
            renderPlaceResultList();
        });
        // 切换到关注点分析Tab时初始化按钮组，每次都调用接口刷新
        const tabFocusResult = document.getElementById('tab-focus-result');
        if (tabFocusResult) {
          tabFocusResult.addEventListener('click', function() {
            renderAddPlaceResultPlaceBtns(); // 每次点击都刷新
          });
        }
        // 查询和重置
        document.getElementById('resultBtnSearch').onclick = function() {
            renderPlaceResultList(1);
        };
        document.getElementById('resultBtnReset').onclick = function() {
            document.getElementById('placeResultSearchForm').reset();
            // 重置对错按钮
            document.querySelectorAll('#resultSearchCorrectBtns button').forEach(btn=>btn.classList.remove('active'));
            document.querySelector('#resultSearchCorrectBtns button[data-correct=""]').classList.add('active');
            renderPlaceResultList(1);
        };
        // 对错按钮事件
        document.querySelectorAll('#resultSearchCorrectBtns button').forEach(btn => {
            btn.onclick = function() {
                document.querySelectorAll('#resultSearchCorrectBtns button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                renderPlaceResultList(1);
            };
        });
        // 每页条数按钮
        window.addEventListener('click', function(e) {
            if (e.target && e.target.closest && e.target.closest('#placeResultPageSizeBtns')) {
                const btn = e.target.closest('button[data-size]');
                if (btn) {
                    const group = btn.parentElement;
                    group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    placeResultPageSize = parseInt(btn.getAttribute('data-size'), 10);
                    placeResultPage = 1;
                    renderPlaceResultList(1);
                }
            }
        });
        // 编辑对错弹窗按钮
        const editBtns = document.getElementById('editPlaceResultCorrectBtns');
        if (editBtns) {
            editBtns.querySelectorAll('button').forEach(btn => {
                btn.onclick = function() {
                    editBtns.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('editPlaceResultIsCorrect').value = this.getAttribute('data-correct');
                };
            });
        }
        // 保存编辑
        document.getElementById('saveEditPlaceResultBtn').onclick = async function() {
            const id = editingPlaceResultId;
            const is_correct = document.getElementById('editPlaceResultIsCorrect').value;
            const res = await updatePlaceResult(id, is_correct === '' ? null : Number(is_correct));
            if (res.success) {
                bootstrap.Modal.getInstance(document.getElementById('editPlaceResultModal')).hide();
                renderPlaceResultList();
            } else {
                alert(res.error || '保存失败');
            }
        };
        // 关注点登记结果Tab下登记表单提交
        const addPlaceResultForm = document.getElementById('addPlaceResultForm');
        if (addPlaceResultForm) {
            addPlaceResultForm.onsubmit = async function(e) {
                e.preventDefault();
                const place_id = document.getElementById('addPlaceResultPlaceId').value;
                const qishu = document.getElementById('addPlaceResultQishu').value.trim();
                // 获取radio选中的对错
                const is_correct = document.querySelector('input[name="addPlaceResultIsCorrectRadio"]:checked').value;
                if (!place_id || !qishu) {
                    alert('关注点和期数不能为空');
                    return;
                }
                const resp = await fetch('/api/place-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ place_id, qishu, is_correct: is_correct === '' ? null : Number(is_correct) })
                });
                const result = await resp.json();
                if (result.success) {
                    this.reset();
                    renderPlaceResultList(1);
                } else {
                    alert(result.error || '登记失败');
                }
            };
        }
    });
    </script>
    <!-- 关注点分析Tab内容，关注点选择由下拉框改为按钮组 -->
    <script>
    // 渲染分析关注点按钮组，按钮后显示当前遗漏或连中
    async function renderAnalysisPlaceBtnsWithStats() {
        // 先获取所有关注点的当前遗漏/连中
        const stats = {};
        for (const p of allPlacesCache) {
            let stat = '';
            try {
                const resp = await fetch(`/api/place-analysis?place_id=${p.id}`);
                const result = await resp.json();
                if (result.success && result.data) {
                    if (result.data.current_miss > 0) {
                        stat = `（遗漏${result.data.current_miss}）`;
                    } else if (result.data.current_streak > 0) {
                        stat = `（连中${result.data.current_streak}）`;
                    }
                }
            } catch(e) {}
            stats[p.id] = stat;
        }
        const btns = allPlacesCache.map((p, idx) =>
            `<button type='button' class='btn btn-outline-primary${idx===0?' active':''}' data-id='${p.id}'>${p.name}${stats[p.id]}</button>`
        ).join('');
        document.getElementById('analysisPlaceBtns').innerHTML = btns;
    }
    // 绑定按钮点击事件
    function bindAnalysisPlaceBtnEvents() {
        const btnGroup = document.getElementById('analysisPlaceBtns');
        btnGroup.querySelectorAll('button').forEach(btn => {
            btn.onclick = async function() {
                btnGroup.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const place_id = this.getAttribute('data-id');
                const data = await fetchPlaceAnalysis(place_id);
                await renderAnalysisResult(data);
            };
        });
    }
    // 获取分析数据
    async function fetchPlaceAnalysis(place_id) {
        const resp = await fetch(`/api/place-analysis?place_id=${place_id}`);
        const result = await resp.json();
        if (result.success) return result.data;
        return null;
    }
    // 获取关注点明细
    async function fetchPlaceResultsForAnalysis(place_id) {
        const url = new URL('/api/place-results', window.location.origin);
        url.searchParams.append('place_id', place_id);
        const resp = await fetch(url);
        const result = await resp.json();
        if (result.success) return result.data;
        return [];
    }
    // 渲染分析结果（含明细表格）
    async function renderAnalysisResult(data) {
        if (!data) {
            document.getElementById('analysisResult').innerHTML = '<div class="alert alert-warning">暂无数据</div>';
            return;
        }
        let html = '';
        // 统计卡片
        html += `<div class='analysis-stat-card'>`;
        html += `<div class='stat-item'>总期数：<span>${data.total}</span></div>`;
        html += `<div class='stat-item'>命中：<span>${data.correct}</span></div>`;
        html += `<div class='stat-item'>未中：<span>${data.wrong}</span></div>`;
        html += `<div class='stat-item'>未判断：<span>${data.unjudged}</span></div>`;
        html += `</div>`;
        // 明细表格
        if (data.place_id) {
            const details = await fetchPlaceResultsForAnalysis(data.place_id);
            if (Array.isArray(details) && details.length) {
                // 按期数倒序
                details.sort((a,b)=>(b.qishu||'').localeCompare(a.qishu||''));
                html += `<div class='analysis-table-wrap'>`;
                html += `<div class='fw-bold mb-2'>全部明细</div>`;
                html += `<table class='table table-bordered table-sm table-hover'>`;
                html += `<thead><tr><th>期数</th><th>对错</th><th>创建时间</th><th>更新时间</th></tr></thead>`;
                html += `<tbody>`;
                details.slice(0,30).forEach(item => {
                    html += `<tr>`;
                    html += `<td>${item.qishu}</td>`;
                    html += `<td>${item.is_correct === 1 ? '正确' : (item.is_correct === 0 ? '错误' : '未判断')}</td>`;
                    html += `<td>${item.created_at || ''}</td>`;
                    html += `<td>${item.updated_at || ''}</td>`;
                    html += `</tr>`;
                });
                html += `</tbody>`;
                html += `</table>`;
                html += `</div>`;
                // 命中明细表格
                const hitList = details.filter(item => item.is_correct === 1);
                html += `<div class='analysis-table-wrap mt-4'>`;
                html += `<div class='fw-bold mb-2 text-success'>命中明细</div>`;
                if (hitList.length) {
                    html += `<table class='table table-bordered table-sm table-hover'>`;
                    html += `<thead><tr><th>期数</th><th>对错</th><th>创建时间</th><th>更新时间</th></tr></thead>`;
                    html += `<tbody>`;
                    hitList.slice(0,30).forEach(item => {
                        html += `<tr>`;
                        html += `<td>${item.qishu}</td>`;
                        html += `<td>正确</td>`;
                        html += `<td>${item.created_at || ''}</td>`;
                        html += `<td>${item.updated_at || ''}</td>`;
                        html += `</tr>`;
                    });
                    html += `</tbody>`;
                    html += `</table>`;
                } else {
                    html += `<div class='alert alert-info mb-0'>暂无命中记录</div>`;
                }
                html += `</div>`;
            } else {
                html += `<div class='alert alert-info'>暂无明细数据</div>`;
            }
        }
        // 分析统计卡片
        html += `<div class='analysis-stat-card'>`;
        html += `<div class='stat-item'>命中率：<span>${(data.hit_rate*100).toFixed(2)}%</span></div>`;
        html += `<div class='stat-item'>当前遗漏：<span>${data.current_miss}</span></div>`;
        html += `<div class='stat-item'>最大遗漏：<span>${data.max_miss}</span></div>`;
        html += `<div class='stat-item'>当前连中：<span>${data.current_streak}</span></div>`;
        html += `<div class='stat-item'>最大连中：<span>${data.max_streak}</span></div>`;
        html += `</div>`;
        document.getElementById('analysisResult').innerHTML = html;
    }
    document.addEventListener('DOMContentLoaded', function() {
        // 关注点分析Tab初始化
        const tabFocusAnalysis = document.getElementById('tab-focus-analysis');
        if (tabFocusAnalysis) {
            tabFocusAnalysis.addEventListener('click', async function() {
                // 先刷新关注点缓存，确保按钮有数据
                allPlacesCache = await fetchPlaces();
                await renderAnalysisPlaceBtnsWithStats();
                bindAnalysisPlaceBtnEvents();
                // 自动分析第一个关注点
                const firstBtn = document.querySelector('#analysisPlaceBtns button');
                if (firstBtn) {
                    firstBtn.classList.add('active');
                    const place_id = firstBtn.getAttribute('data-id');
                    const data = await fetchPlaceAnalysis(place_id);
                    renderAnalysisResult(data);
                } else {
                    document.getElementById('analysisResult').innerHTML = '<div class="alert alert-info">暂无关注点</div>';
                }
            });
        }
    });
    </script>
    <script>
    // 渲染投注点按钮组
    async function renderBetReportPlaceBtns() {
      const resp = await fetch('/api/places/simple');
      const result = await resp.json();
      if (!result.success) return;
      const places = result.data;
      // 增加"全部"按钮
      let btns = `<button type='button' class='btn btn-outline-secondary active' data-id=''>全部</button>`;
      btns += places.map((p) =>
        `<button type='button' class='btn btn-outline-primary' data-id='${p.id}'>${p.name}</button>`
      ).join('');
      document.getElementById('betReportPlaceBtns').innerHTML = btns;
      // 默认选中"全部"
      document.getElementById('betReportPlaceId').value = '';
      // 绑定点击事件
      document.querySelectorAll('#betReportPlaceBtns button').forEach(btn => {
        btn.onclick = function() {
          document.querySelectorAll('#betReportPlaceBtns button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('betReportPlaceId').value = this.getAttribute('data-id');
          fetchBetReportStats();
          fetchBetReportTable();
        };
      });
    }
    // 对错按钮事件
    function bindBetReportIsCorrectBtns() {
      document.querySelectorAll('#betReportIsCorrectBtns button').forEach(btn => {
        btn.onclick = function() {
          document.querySelectorAll('#betReportIsCorrectBtns button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          fetchBetReportStats();
          fetchBetReportTable();
        };
      });
    }
    // 获取当前对错筛选
    function getBetReportIsCorrect() {
      const btn = document.querySelector('#betReportIsCorrectBtns button.active');
      return btn ? btn.getAttribute('data-correct') : '';
    }
    // 获取当前选中的关注点ID
    function getBetReportPlaceId() {
      const btn = document.querySelector('#betReportPlaceBtns button.active');
      return btn ? btn.getAttribute('data-id') : '';
    }
    // ... 修改fetchBetReportStats和fetchBetReportTable ...
    async function fetchBetReportStats() {
      const place_id = getBetReportPlaceId();
      let is_correct = getBetReportIsCorrect();
      if (is_correct === '-1') is_correct = null;
      const start_date = document.getElementById('betReportStartDate').value;
      const end_date = document.getElementById('betReportEndDate').value;
      const params = new URLSearchParams();
      if (place_id) params.append('place_id', place_id);
      if (is_correct !== '') params.append('is_correct', is_correct);
      if (start_date) params.append('start_date', start_date);
      if (end_date) params.append('end_date', end_date);
      const resp = await fetch('/api/bet-report?' + params.toString());
      const result = await resp.json();
      if (result.success && result.data) {
        renderBetReportStats(result.data);
      } else {
        document.getElementById('betReportStats').innerHTML = '<div class="alert alert-info">暂无数据</div>';
      }
    }
    async function fetchBetReportTable(page=1, pageSize=30) {
      const place_id = getBetReportPlaceId();
      let is_correct = getBetReportIsCorrect();
      if (is_correct === '-1') is_correct = null;
      const start_date = document.getElementById('betReportStartDate').value;
      const end_date = document.getElementById('betReportEndDate').value;
      const params = new URLSearchParams();
      if (place_id) params.append('place_id', place_id);
      if (is_correct !== '') params.append('is_correct', is_correct);
      if (start_date) params.append('start_date', start_date);
      if (end_date) params.append('end_date', end_date);
      const resp = await fetch('/api/bets?' + params.toString());
      const result = await resp.json();
      if (result.success && Array.isArray(result.data)) {
        renderBetReportTable(result.data, page, pageSize);
      } else {
        document.getElementById('betReportTable').innerHTML = '<div class="alert alert-info">暂无明细数据</div>';
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      // 投注点报表Tab初始化
      const tabBetReport = document.getElementById('tab-bet-report');
      if (tabBetReport) {
        tabBetReport.addEventListener('click', async function() {
          await renderBetReportPlaceBtns();
          bindBetReportIsCorrectBtns();
          await fetchBetReportStats();
          await fetchBetReportTable();
        });
      }
      // 页面初始加载时自动加载全部数据
      if (window.location.hash === '#bet-report' || document.querySelector('.nav-link.active')?.id === 'tab-bet-report') {
        renderBetReportPlaceBtns().then(() => {
          bindBetReportIsCorrectBtns();
          fetchBetReportStats();
          fetchBetReportTable();
        });
      }
      document.getElementById('betReportBtnSearch').onclick = function() {
        fetchBetReportStats();
        fetchBetReportTable();
      };
      document.getElementById('betReportBtnReset').onclick = function() {
        document.getElementById('betReportSearchForm').reset();
        // 重置按钮组
        const allBtn = document.querySelector('#betReportPlaceBtns button[data-id=""]');
        if (allBtn) {
          document.querySelectorAll('#betReportPlaceBtns button').forEach(b => b.classList.remove('active'));
          allBtn.classList.add('active');
          document.getElementById('betReportPlaceId').value = '';
        }
        document.querySelectorAll('#betReportIsCorrectBtns button').forEach((b,i)=>{
          b.classList.remove('active');
          if(i===0) b.classList.add('active');
        });
        fetchBetReportStats();
        fetchBetReportTable();
      };
    });
    </script>
    <script>
    function renderBetReportStats(data) {
      let html = `<div class='analysis-stat-card mb-3'>`;
      html += `<div class='stat-item'>总投注：<span>${data.total}</span></div>`;
      html += `<div class='stat-item'>总金额：<span>${data.total_amount.toFixed(2)}</span></div>`;
      html += `<div class='stat-item'>命中：<span>${data.correct}</span></div>`;
      html += `<div class='stat-item'>错误：<span>${data.wrong}</span></div>`;
      html += `<div class='stat-item'>未判断：<span>${data.unjudged}</span></div>`;
      html += `<div class='stat-item'>总赢取：<span>${data.total_win.toFixed(2)}</span></div>`;
      html += `<div class='stat-item'>盈亏：<span>${data.profit.toFixed(2)}</span></div>`;
      html += `<div class='stat-item'>命中率：<span>${(data.correct_rate*100).toFixed(2)}%</span></div>`;
      html += `</div>`;
      document.getElementById('betReportStats').innerHTML = html;
    }
    function renderBetReportTable(data, page=1, pageSize=30) {
      if (!data.length) {
        document.getElementById('betReportTable').innerHTML = '<div class="alert alert-info">暂无明细数据</div>';
        return;
      }
      // 分页
      const totalPage = Math.ceil(data.length / pageSize) || 1;
      if (page > totalPage) page = totalPage;
      const startIdx = (page - 1) * pageSize;
      const endIdx = startIdx + pageSize;
      const pageList = data.slice(startIdx, endIdx);
      let html = `<div class='analysis-table-wrap'>`;
      html += `<div class='fw-bold mb-2'>投注明细</div>`;
      html += `<table class='table table-bordered table-sm table-hover'>`;
      html += `<thead><tr><th>期数</th><th>投注金额</th><th>对错</th><th>赢取金额</th><th>投注时间</th><th>更新时间</th></tr></thead>`;
      html += `<tbody>`;
      pageList.forEach(item => {
        html += `<tr>`;
        html += `<td>${item.qishu}</td>`;
        html += `<td>${Number(item.bet_amount).toFixed(2)}</td>`;
        html += `<td>${item.is_correct === 1 ? '正确' : (item.is_correct === 0 ? '错误' : '未判断')}</td>`;
        html += `<td>${Number(item.win_amount).toFixed(2)}</td>`;
        html += `<td>${item.created_at || ''}</td>`;
        html += `<td>${item.updated_at || ''}</td>`;
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      // 分页控件
      html += `<div class='d-flex justify-content-center align-items-center flex-wrap'>`;
      html += `<nav><ul class='pagination pagination-sm mb-0'>`;
      for(let i=1;i<=totalPage;i++){
        html += `<li class='page-item${i===page?' active':''}'><a class='page-link' href='javascript:void(0)' onclick='fetchBetReportTable(${i},${pageSize})'>${i}</a></li>`;
      }
      html += `</ul></nav>`;
      html += `<div class='ms-3' style='min-width:180px;max-width:240px;'><label class='form-label mb-0 me-1' style='font-size:13px;'>每页</label><select id='betReportPageSize' class='form-select form-select-sm' style='width:auto;display:inline-block;'><option value='10'>10</option><option value='30' selected>30</option><option value='100'>100</option></select></div>`;
      html += `</div></div>`;
      document.getElementById('betReportTable').innerHTML = html;
      // 绑定每页条数切换
      document.getElementById('betReportPageSize').onchange = function() {
        fetchBetReportTable(1, Number(this.value));
      };
    }
    // ... existing code ...
    </script>