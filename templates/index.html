<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>彩票开奖数据分析系统</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/font-awesome-local.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/icons.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .stats-card .number {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .lottery-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: 50%;
            margin: 2px;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* 鲜红色球 - 1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46 */
        .lottery-number.red {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
        }
        
        /* 绿色球 - 3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48 */
        .lottery-number.green {
            background: linear-gradient(135deg, #2ed573,rgb(24, 228, 24));
            box-shadow: 0 2px 8px rgba(96, 243, 11, 0.91);
        }
        
        /* 暗蓝色球 - 5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49 */
        .lottery-number.blue {
            background: linear-gradient(135deg, #3742fa, #2f3542);
            box-shadow: 0 2px 8px rgba(55, 66, 250, 0.3);
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #667eea;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .frequency-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .frequency-number {
            font-weight: bold;
            color: #667eea;
        }
        
        .frequency-count {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .recommendation-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .recommendation-list .frequency-item {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        
        .recommendation-list .frequency-item:hover {
            background: #f8f9fa;
            border-left-color: #667eea;
        }
        
        .recommendation-list .top-rank {
            border-left-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }
        
        .recommendation-list .frequency-item:nth-child(1) {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        
        .recommendation-list .frequency-item:nth-child(2) {
            border-left-color: #fd7e14;
            background: rgba(253, 126, 20, 0.1);
        }
        
        .recommendation-list .frequency-item:nth-child(3) {
            border-left-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }
        /* 组合分析美化 */
        .group-balls {
            margin: 8px 0 12px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .group-balls-label {
            font-weight: bold;
            margin-right: 8px;
            min-width: 110px;
        }
        .group-balls .lottery-number {
            width: 32px;
            height: 32px;
            line-height: 32px;
            font-size: 13px;
            margin: 1px 2px;
        }
        .group-stat-card {
            background: linear-gradient(135deg, #f8fafc 60%, #e0e7ff 100%);
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            margin-bottom: 12px;
            border: 1px solid #e0e7ff;
        }
        .group-stat-card h6 {
            color: #667eea;
            font-weight: bold;
        }
        .group-stat-card .stat-label {
            color: #555;
            font-size: 13px;
        }
        .combinations-divider {
            border-top: 2px dashed #764ba2;
            margin: 18px 0 18px 0;
        }
        .miss-detail-table-wrap {
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            padding: 18px 12px 8px 12px;
        }
        #exportDetailCSVBtn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: #222;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(67,233,123,0.12);
        }
        #exportDetailCSVBtn:hover {
            background: linear-gradient(135deg, #38f9d7 0%, #43e97b 100%);
            color: #111;
        }
        .comb-filter-card {
            background: linear-gradient(135deg, #f8fafc 60%, #e0e7ff 100%);
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(102,126,234,0.10);
            padding: 18px 24px 10px 24px;
            margin-bottom: 18px;
            border: 1px solid #e0e7ff;
        }
        .comb-filter-card label {
            font-weight: bold;
            color: #4f4f8f;
        }
        .comb-filter-card .form-select {
            min-width: 120px;
        }
        .comb-filter-card .btn-primary {
            margin-top: 8px;
        }
        .miss-detail-table-wrap {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(102,126,234,0.10);
            padding: 18px 12px 8px 12px;
            margin-top: 10px;
        }
        .miss-detail-table-wrap .table thead.table-dark th {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%) !important;
            color: #fff;
            border: none;
        }
        .miss-detail-table-wrap .table tbody tr:hover {
            background: #f0f4ff;
            transition: background 0.2s;
        }
        .miss-detail-table-wrap .table-bordered {
            border-radius: 10px;
            overflow: hidden;
        }
        .miss-detail-table-wrap .d-flex .btn {
            min-width: 90px;
        }
        .miss-detail-table-wrap .d-flex span {
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 头部 -->
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> 彩票开奖数据分析系统</h1>
                <p class="text-muted">专业的彩票数据分析和统计平台</p>
            </div>

            <!-- 统计卡片 -->
            <div class="row" id="statsCards">
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3><i class="fas fa-list"></i> 总期数</h3>
                        <div class="number" id="totalCount">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3><i class="fas fa-calendar"></i> 最新开奖</h3>
                        <div class="number" id="latestTime">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3><i class="fas fa-clock"></i> 最早开奖</h3>
                        <div class="number" id="earliestTime">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3><i class="fas fa-chart-bar"></i> 数据范围</h3>
                        <div class="number" id="dataRange">-</div>
                    </div>
                </div>
            </div>

            <!-- 导航标签 -->
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-home"></i> 概览
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="frequency-tab" data-bs-toggle="tab" data-bs-target="#frequency" type="button" role="tab">
                        <i class="fas fa-star"></i> 第七码推荐
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab">
                        <i class="fas fa-sort-numeric-up"></i> 第七码十位分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="combinations-tab" data-bs-toggle="tab" data-bs-target="#combinations" type="button" role="tab">
                        <i class="fas fa-puzzle-piece"></i> 组合分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sixplusminus-tab-btn" data-bs-toggle="tab" data-bs-target="#sixplusminus-tab" type="button" role="tab">
                        <i class="fas fa-magic"></i> 前6码±1推荐
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="plus20-tab" data-bs-toggle="tab" data-bs-target="#plus20" type="button" role="tab">
                        <i class="fas fa-th-list"></i> +1~+20区间分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">
                        <i class="fas fa-table"></i> 开奖数据
                    </button>
                </li>
            </ul>

            <!-- 标签内容 -->
            <div class="tab-content" id="mainTabsContent">
                <!-- 概览 -->
                <div class="tab-pane fade" id="overview" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-chart-pie"></i> 号码分布</h4>
                                <canvas id="numberDistributionChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-chart-bar"></i> 奇偶分布</h4>
                                <canvas id="oddEvenChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="chart-container">
                                <h4><i class="fas fa-clock"></i> 最近开奖记录</h4>
                                <div id="recentData"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 第七码高频推荐 -->
                <div class="tab-pane fade" id="frequency" role="tabpanel">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="chart-container">
                                <h4><i class="fas fa-star"></i> 推荐详情</h4>
                                <div id="frequencyDetails"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 第七码十位分析 -->
                <div class="tab-pane fade" id="trends" role="tabpanel">
                    <div class="chart-container">
                        <h4><i class="fas fa-sort-numeric-up"></i> 第N码十位组合遗漏分析</h4>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="trendPosition" class="form-label">分析号码位置</label>
                                <select class="form-select" id="trendPosition">
                                    <option value="1">第1个码</option>
                                    <option value="2">第2个码</option>
                                    <option value="3">第3个码</option>
                                    <option value="4">第4个码</option>
                                    <option value="5">第5个码</option>
                                    <option value="6">第6个码</option>
                                    <option value="7" selected>第7个码</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="trendYear" class="form-label">年份</label>
                                <select class="form-select" id="trendYear">
                                    <option value="all">全部</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="trendThreshold" class="form-label">高亮阀值</label>
                                <input type="number" class="form-control" id="trendThreshold" value="10" min="1" max="100" onchange="updateSeventhTensView()">
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button class="btn btn-primary ms-2" onclick="loadSeventhTensAnalysis()">
                                    <i class="fas fa-sync"></i> 刷新分析
                                </button>
                            </div>
                        </div>
                        <div id="seventhTensStats" class="mb-3"></div>
                        <div id="seventhTensTable"></div>
                    </div>
                </div>

                <!-- 组合分析 -->
                <div class="tab-pane fade" id="combinations" role="tabpanel">
                    <div class="comb-filter-card">
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <label for="combTargetCol" class="form-label">分析号码位置</label>
                                <select class="form-select" id="combTargetCol">
                                    <option value="1">第1个码</option>
                                    <option value="2">第2个码</option>
                                    <option value="3">第3个码</option>
                                    <option value="4">第4个码</option>
                                    <option value="5">第5个码</option>
                                    <option value="6">第6个码</option>
                                    <option value="7" selected>第7个码</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="combYear" class="form-label">年份</label>
                                <select class="form-select" id="combYear">
                                    <option value="all">全部</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button class="btn btn-primary ms-2" onclick="loadCombinations()"><i class="fas fa-sync"></i> 刷新分析</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="chart-container">
                                <h4><i class="fas fa-info-circle"></i> 组合分析结果</h4>
                                <div id="combinationsDetails"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 前6码±1推荐 -->
                <div class="tab-pane fade" id="sixplusminus-tab" role="tabpanel">
                    <div class="chart-container">
                        <h4><i class="fas fa-magic"></i> 前6码±1推荐分析</h4>
                        <div class="mb-3">
                            <label class="form-label">加减范围</label>
                            <span id="sixpm-n-btns" class="me-3"></span>
                            <label class="form-label ms-3">年份</label>
                            <span id="sixpm-year-btns" class="me-3"></span>
                            <label for="sixpm-threshold" class="form-label ms-3">高亮阀值</label>
                            <input type="number" class="form-control" id="sixpm-threshold" value="10" min="1" max="100" style="width:120px;display:inline-block;">
                            <button class="btn btn-primary ms-2" onclick="loadSixPlusMinusAnalysis()"><i class="fas fa-sync"></i> 刷新分析</button>
                            <button class="btn btn-success ms-2" onclick="exportSixPlusMinusCSV()"><i class="fas fa-file-csv"></i> 导出CSV</button>
                        </div>
                        <div id="sixpm-stats" class="mb-3"></div>
                        <div id="sixpm-table"></div>
                    </div>
                </div>

                <!-- +1~+20区间分析 -->
                <div class="tab-pane fade" id="plus20" role="tabpanel">
                    <div class="chart-container">
                        <h4><i class="fas fa-th-list"></i> 每个码+1~+20区间命中/遗漏分析</h4>
                        <div class="mb-3">
                            <label class="form-label me-2">区间</label>
                            <span id="plus20-range-btns" class="me-3"></span>
                            <label class="form-label me-2">年份</label>
                            <span id="plus20-year-btns" class="me-3"></span>
                            <label for="plus20-threshold" class="form-label">高亮阀值</label>
                            <input type="number" class="form-control" id="plus20-threshold" value="10" min="1" max="50" style="width:120px;display:inline-block;">
                            <button class="btn btn-primary ms-2" onclick="loadPlus20Intervals()"><i class="fas fa-sync"></i> 刷新分析</button>
                        </div>
                        <div id="plus20Table"></div>
                    </div>
                </div>

                <!-- 开奖数据 -->
                <div class="tab-pane fade show active" id="data" role="tabpanel">
                    <div class="filter-section">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="dataLimit" class="form-label">显示条数</label>
                                <select class="form-select" id="dataLimit">
                                    <option value="50">50条</option>
                                    <option value="100">100条</option>
                                    <option value="200">200条</option>
                                    <option value="500">500条</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="startDate" class="form-label">开始日期</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-3">
                                <label for="endDate" class="form-label">结束日期</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary d-block" onclick="loadData()">
                                    <i class="fas fa-search"></i> 查询数据
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="data-table">
                        <h4><i class="fas fa-table"></i> 开奖数据列表</h4>
                        <div id="dataTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // 全局变量
        let charts = {};
        let currentData = {};

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 默认激活开奖数据Tab
            var dataTab = document.getElementById('data-tab');
            if (dataTab) {
                var tab = new bootstrap.Tab(dataTab);
                tab.show();
            }
            fillTrendYearOptions();
            loadSeventhTensAnalysis();
            fillCombYearOptions();
            fillSixpmYearOptions();
            fillSixpmNOptions();
            fillPlus20YearOptions();
            fillPlus20RangeOptions();
            loadData();
        });

        // 加载统计数据
        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('totalCount').textContent = data.total_count || 0;
                    document.getElementById('latestTime').textContent = data.latest_time ? new Date(data.latest_time).toLocaleDateString() : '-';
                    document.getElementById('earliestTime').textContent = data.earliest_time ? new Date(data.earliest_time).toLocaleDateString() : '-';
                    
                    if (data.latest_time && data.earliest_time) {
                        const days = Math.ceil((new Date(data.latest_time) - new Date(data.earliest_time)) / (1000 * 60 * 60 * 24));
                        document.getElementById('dataRange').textContent = days + '天';
                    }
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载概览数据
        async function loadOverview() {
            try {
                const response = await fetch('/api/analysis');
                const result = await response.json();
                
                if (result.success) {
                    currentData.analysis = result.data;
                    createOverviewCharts();
                }
            } catch (error) {
                console.error('加载概览数据失败:', error);
            }
        }

        // 创建概览图表
        function createOverviewCharts() {
            const analysis = currentData.analysis;
            if (!analysis) return;

            // 号码分布图
            const distributionCtx = document.getElementById('numberDistributionChart').getContext('2d');
            if (charts.numberDistribution) {
                charts.numberDistribution.destroy();
            }
            
            const frequencyData = analysis.frequency?.frequency || {};
            const labels = Object.keys(frequencyData).slice(0, 20);
            const data = labels.map(key => frequencyData[key]);
            
            // 根据号码设置颜色
            const colors = labels.map(num => {
                const colorClass = getNumberColorClass(parseInt(num));
                if (colorClass === 'red') return 'rgba(255, 71, 87, 0.8)';
                if (colorClass === 'green') return 'rgba(46, 213, 115, 0.8)';
                if (colorClass === 'blue') return 'rgba(55, 66, 250, 0.8)';
                return 'rgba(102, 126, 234, 0.8)'; // 默认颜色
            });
            
            charts.numberDistribution = new Chart(distributionCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '出现次数',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 奇偶分布图
            const oddEvenCtx = document.getElementById('oddEvenChart').getContext('2d');
            if (charts.oddEven) {
                charts.oddEven.destroy();
            }
            
            const oddEvenData = analysis.analysis?.odd_even || {};
            const oddCount = Object.values(oddEvenData).reduce((sum, item) => sum + item.odd, 0);
            const evenCount = Object.values(oddEvenData).reduce((sum, item) => sum + item.even, 0);
            
            charts.oddEven = new Chart(oddEvenCtx, {
                type: 'doughnut',
                data: {
                    labels: ['奇数', '偶数'],
                    datasets: [{
                        data: [oddCount, evenCount],
                        backgroundColor: ['#ff6b6b', '#4ecdc4'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 获取号码的颜色类
        function getNumberColorClass(num) {
            const redNumbers = [1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46];
            const greenNumbers = [3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48];
            const blueNumbers = [5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49];
            
            if (redNumbers.includes(num)) {
                return 'red';
            } else if (greenNumbers.includes(num)) {
                return 'green';
            } else if (blueNumbers.includes(num)) {
                return 'blue';
            } else {
                return ''; // 默认颜色
            }
        }

        // 创建带颜色的号码球HTML
        function createNumberBall(num) {
            const colorClass = getNumberColorClass(num);
            return `<span class="lottery-number ${colorClass}">${num}</span>`;
        }

        // 加载最近开奖数据
        async function loadRecentData() {
            try {
                const response = await fetch('/api/recent');
                const result = await response.json();
                
                if (result.success) {
                    displayRecentData(result.data);
                }
            } catch (error) {
                console.error('加载最近数据失败:', error);
            }
        }

        // 显示最近开奖数据
        function displayRecentData(data) {
            const container = document.getElementById('recentData');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">暂无开奖数据</div>';
                return;
            }
            
            let html = '<div class="table-responsive">';
            html += '<table class="table table-hover">';
            html += '<thead class="table-dark"><tr><th>期数</th><th>开奖时间</th><th>开奖号码</th></tr></thead><tbody>';
            
            data.forEach((item, index) => {
                const rowClass = index === 0 ? 'table-warning' : '';
                html += `<tr class="${rowClass}">`;
                html += `<td><strong>${item.qishu}</strong></td>`;
                html += `<td>${item.draw_time}</td>`;
                html += '<td>';
                item.numbers.forEach(num => {
                    html += createNumberBall(num);
                });
                html += '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            // 添加说明文字
            html += '<div class="mt-3">';
            html += '<div class="row text-center">';
            html += '<div class="col-md-4"><span class="lottery-number red" style="width: 25px; height: 25px; line-height: 25px; font-size: 12px;">1</span> 鲜红色球</div>';
            html += '<div class="col-md-4"><span class="lottery-number green" style="width: 25px; height: 25px; line-height: 25px; font-size: 12px;">3</span> 绿色球</div>';
            html += '<div class="col-md-4"><span class="lottery-number blue" style="width: 25px; height: 25px; line-height: 25px; font-size: 12px;">5</span> 暗蓝色球</div>';
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // 标签切换事件
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(event) {
                const target = event.target.getAttribute('data-bs-target');
                
                switch(target) {
                    case '#overview':
                        loadOverview();
                        loadRecentData();
                        break;
                    case '#frequency':
                        loadFrequency();
                        break;
                    case '#trends':
                        loadSeventhTensAnalysis();
                        break;
                    case '#combinations':
                        loadCombinations();
                        break;
                    case '#sixplusminus-tab':
                        loadSixPlusMinusAnalysis();
                        break;
                    case '#plus20':
                        loadPlus20Intervals();
                        break;
                    case '#data':
                        loadData();
                        break;
                }
            });
        });

        // 加载第七码高频推荐数据
        async function loadFrequency() {
            try {
                const response = await fetch('/api/seventh-number-recommendation');
                const result = await response.json();
                
                if (result.success) {
                    // 将策略信息添加到数据中
                    const dataWithStrategy = {
                        ...result.data,
                        strategy: result.strategy || '第七码高频推荐',
                        current_qishu: result.current_qishu,
                        reference_qishu: result.reference_qishu
                    };
                    
                    displaySeventhNumberDetails(dataWithStrategy);
                }
            } catch (error) {
                console.error('加载第七码推荐数据失败:', error);
            }
        }

        // 显示第七码推荐详情
        function displaySeventhNumberDetails(data) {
            const container = document.getElementById('frequencyDetails');
            const recommendations = data.recommendations || [];
            // 新增：横向展示8个推荐号码球，按从小到大排序
            const sortedNumbers = recommendations.map(r => r.number).sort((a, b) => a - b);
            let html = '';
            if (sortedNumbers.length > 0) {
                html += '<div class="mb-3 d-flex align-items-center justify-content-center">';
                sortedNumbers.forEach(num => {
                    const colorClass = getNumberColorClass(parseInt(num));
                    html += `<span class="lottery-number ${colorClass}" style="width: 38px; height: 38px; line-height: 38px; font-size: 16px; margin: 0 6px;">${num}</span>`;
                });
                html += '</div>';
            }
            html += '<div class="recommendation-list">';
            html += '<h5>推荐号码详情</h5>';
            
            // 显示策略信息
            if (data.strategy) {
                html += `<div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> <strong>推荐策略:</strong> ${data.strategy}
                </div>`;
            }
            
            recommendations.forEach((item, index) => {
                const colorClass = getNumberColorClass(parseInt(item.number));
                const rankClass = index < 3 ? 'top-rank' : '';
                
                html += `<div class="frequency-item ${rankClass}">`;
                html += `<div class="d-flex align-items-center justify-content-between">`;
                html += `<div class="d-flex align-items-center">`;
                html += `<span class="lottery-number ${colorClass}" style="width: 35px; height: 35px; line-height: 35px; font-size: 14px; margin-right: 10px;">${item.number}</span>`;
                html += `<div>`;
                html += `<div class="fw-bold">第${index + 1}推荐</div>`;
                if (item.frequency > 0) {
                    html += `<small class="text-muted">出现${item.frequency}次</small>`;
                } else {
                    html += `<small class="text-muted">历史推荐</small>`;
                }
                // 推荐原因
                if (item.reason) {
                    html += `<div class='badge bg-info text-dark ms-1'>推荐原因：${item.reason}</div>`;
                }
                html += `</div>`;
                html += `</div>`;
                html += `<div class="text-end">`;
                if (item.avg_interval > 0) {
                    html += `<div class="fw-bold text-primary">${item.avg_interval}期</div>`;
                    html += `<small class="text-muted">平均间隔</small>`;
                } else {
                    html += `<div class="fw-bold text-success">推荐</div>`;
                    html += `<small class="text-muted">历史数据</small>`;
                }
                html += `</div>`;
                html += `</div>`;
                html += `</div>`;
            });
            
            html += '</div>';
            
            // 添加说明文字
            html += '<div class="mt-3 p-3 bg-light rounded">';
            html += '<h6><i class="fas fa-info-circle"></i> 推荐说明</h6>';
            html += '<ul class="mb-0 small">';
            html += '<li>本推荐基于近50期第七码的历史开奖数据，统计出现频率和平均间隔，优先选择每5期左右出现一次且近期活跃的号码。</li>';
            html += '<li>每逢0、5尾数期数自动生成新推荐，其它期数则采用最近的0或5尾数期的推荐结果。</li>';
            html += '<li>仅供娱乐参考，请理性购彩。</li>';
            html += '</ul>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // 加载第N码十位分析
        let seventhTensAllData = {};
        async function loadSeventhTensAnalysis() {
            try {
                const position = document.getElementById('trendPosition').value;
                const year = document.getElementById('trendYear').value;
                let url = `/api/seventh-digit-tens-analysis?position=${position}`;
                if (year && year !== 'all') url += `&year=${year}`;
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    seventhTensAllData = result.data || {};
                    updateSeventhTensView();
                } else {
                    document.getElementById('seventhTensStats').innerHTML = '<div class="error">没有找到数据</div>';
                    document.getElementById('seventhTensTable').innerHTML = '';
                }
            } catch (error) {
                document.getElementById('seventhTensStats').innerHTML = '<div class="error">加载数据失败</div>';
                document.getElementById('seventhTensTable').innerHTML = '';
            }
        }
        // 移除十位组合下拉框的事件监听
        // document.getElementById('tensComb').addEventListener('change', updateSeventhTensView);
        document.getElementById('trendPosition').addEventListener('change', loadSeventhTensAnalysis);
        document.getElementById('trendYear').addEventListener('change', loadSeventhTensAnalysis);
        // 动态填充年份下拉框
        async function fillTrendYearOptions() {
            try {
                const response = await fetch('/api/data?limit=10000');
                const result = await response.json();
                if (result.success) {
                    const years = new Set();
                    (result.data||[]).forEach(item => {
                        if(item.qishu && item.qishu.length>=4) years.add(item.qishu.slice(0,4));
                    });
                    const yearArr = Array.from(years).sort((a,b)=>b.localeCompare(a));
                    const select = document.getElementById('trendYear');
                    select.innerHTML = '<option value="all">全部</option>' + yearArr.map(y=>`<option value="${y}">${y}</option>`).join('');
                }
            } catch(e) {console.error('年份选项加载失败',e);}
        }
        document.addEventListener('DOMContentLoaded', function() {
            fillTrendYearOptions();
            loadSeventhTensAnalysis();
        });
        function updateSeventhTensView() {
            // 直接默认comb为'01'，或遍历所有组合
            // const comb = document.getElementById('tensComb').value;
            // 这里可以默认显示所有组合统计
            // 例如：显示所有组合的最大遗漏
            displaySeventhTensStats(seventhTensAllData);
            // 也可以默认显示01组合明细
            displaySeventhTensTable((seventhTensAllData['01']||{}).detail_rows||[]);
        }
        function displaySeventhTensStats(data) {
            // 统计所有组合最大遗漏
            const combs = ['01','02','03','04','12','13','14','23','24','34'];
            let maxMissRow = '<div class="row mb-2">';
            for(const c of combs){
                const maxMiss = (seventhTensAllData[c]?.max_miss)||0;
                maxMissRow += `<div class='col-auto'><div class='card p-2 text-center' style='min-width:70px;'><div class='fw-bold' style='font-size:1.2rem;'>${c}</div><div class='text-danger fw-bold' style='font-size:1.3rem;'>${maxMiss}</div><div style='font-size:0.9rem;'>最大遗漏</div></div></div>`;
            }
            maxMissRow += '</div>';
            // 旧统计卡片
            let html = maxMissRow;
             
            document.getElementById('seventhTensStats').innerHTML = html;
        }
        function displaySeventhTensTable(rows) {
            if (!rows || rows.length === 0) {
                document.getElementById('seventhTensTable').innerHTML = '<div class="text-center text-muted py-4">暂无明细数据</div>';
                return;
            }
            // 需要全局的seventhTensAllData，rows为当前组合的明细，但我们要所有组合的遗漏数据
            const combs = ['01','02','03','04','12','13','14','23','24','34'];
            // 以某一组（如01）为基准遍历所有期数
            const baseRows = (seventhTensAllData['01']?.detail_rows||[]).slice().reverse();
            // 获取高亮阀值
            const threshold = parseInt(document.getElementById('trendThreshold')?.value || '10', 10);
            let html = '<div class="miss-detail-table-wrap">';
            html += '<div class="table-responsive">';
            html += '<table class="table table-bordered table-sm table-hover">';
            html += '<thead class="table-dark"><tr>' +
                '<th>期数</th><th>开奖时间</th><th>第N码</th><th>十位' +
                combs.map(c=>`<th>${c}</th>`).join('') +
                '</tr></thead><tbody>';
            for(let i=0;i<baseRows.length;i++){
                const r = baseRows[i];
                html += `<tr>`;
                html += `<td>${r.qishu}</td>`;
                html += `<td>${r.draw_time}</td>`;
                html += `<td>${r.number}</td>`;
                html += `<td>${r.tens}</td>`;
                // 每组的遗漏数据
                for(const c of combs){
                    const groupRows = (seventhTensAllData[c]?.detail_rows||[]).slice().reverse();
                    const miss = groupRows[i]?.miss_streak || 0;
                    let cellStyle = '';
                    if(miss === 0) cellStyle = " style='color:#28a745;font-weight:bold;'";
                    else if(miss >= threshold) cellStyle = " style='color:#fff;background:#d9534f;font-weight:bold;'";
                    html += `<td${cellStyle}>${miss}</td>`;
                }
                html += `</tr>`;
            }
            html += '</tbody></table></div></div>';
            document.getElementById('seventhTensTable').innerHTML = html;
        }
        // 页面加载时默认加载
        document.addEventListener('DOMContentLoaded', function() {
            loadSeventhTensAnalysis();
        });

        // 加载组合分析
        async function loadCombinations() {
            try {
                const targetCol = document.getElementById('combTargetCol').value;
                const year = document.getElementById('combYear').value;
                const response = await fetch(`/api/combinations?target_col=${targetCol}`);
                const result = await response.json();
                if (result.success) {
                    // 前端按年份筛选
                    let data = result.data;
                    if (year !== 'all') {
                        // 只保留该年份明细
                        const yearStr = year + '';
                        data.detail_rows = (data.detail_rows||[]).filter(r => (r.qishu||'').toString().startsWith(yearStr));
                    }
                    displayCombinationsDetails(data);
                }
            } catch (error) {
                console.error('加载组合数据失败:', error);
            }
        }
        // 动态填充年份下拉框
        async function fillCombYearOptions() {
            try {
                const response = await fetch('/api/data?limit=10000');
                const result = await response.json();
                if (result.success) {
                    const years = new Set();
                    (result.data||[]).forEach(item => {
                        if(item.qishu && item.qishu.length>=4) years.add(item.qishu.slice(0,4));
                    });
                    const yearArr = Array.from(years).sort((a,b)=>b.localeCompare(a));
                    const select = document.getElementById('combYear');
                    select.innerHTML = '<option value="all">全部</option>' + yearArr.map(y=>`<option value="${y}">${y}</option>`).join('');
                }
            } catch(e) {console.error('年份选项加载失败',e);}
        }
        document.addEventListener('DOMContentLoaded', function() {
            fillCombYearOptions();
        });

        // 创建组合图表
        function createCombinationsChart(data) {
            const combinationsCtx = document.getElementById('combinationsChart').getContext('2d');
            if (charts.combinations) {
                charts.combinations.destroy();
            }
            
            const consecutivePercentage = data.consecutive_percentage || 0;
            const duplicatePercentage = data.duplicate_percentage || 0;
            const normalPercentage = 100 - consecutivePercentage - duplicatePercentage;
            
            charts.combinations = new Chart(combinationsCtx, {
                type: 'pie',
                data: {
                    labels: ['连续号码', '重复号码', '正常号码'],
                    datasets: [{
                        data: [consecutivePercentage, duplicatePercentage, normalPercentage],
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 显示组合详情（自定义分组分析）
        function displayCombinationsDetails(data) {
            const container = document.getElementById('combinationsDetails');
            if (!data || !data.group1_numbers || !data.group2_numbers) {
                container.innerHTML = '<div class="alert alert-warning">暂无数据</div>';
                return;
            }
            // 组1/组2号码美化为彩色球
            let html = `<div class="mb-3">
                <div class='group-balls'><span class='group-balls-label'>组1：</span>` + data.group1_numbers.map(num=>`<span class='lottery-number ${getNumberColorClass(num)}'>${num}</span>`).join('') + `</div>` +
                `<div class='group-balls'><span class='group-balls-label'>组2：</span>` + data.group2_numbers.map(num=>`<span class='lottery-number ${getNumberColorClass(num)}'>${num}</span>`).join('') + `</div>` +
                `<div class='mt-2'><strong>分析号码位置：</strong> ${data.target_col.replace('number','第') + '个码'}<br>
                <strong>当前期属于：</strong> ${data.current_group === 1 ? '组1' : data.current_group === 2 ? '组2' : '其它'}</div>
            </div>`;
            html += `<div class='combinations-divider'></div>`;
            // 统计数字卡片美化
            function stat(arr) {
                if (!arr.length) return {max:0, avg:0};
                return {
                    max: Math.max(...arr),
                    avg: (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2)
                };
            }
            const g1miss = stat(data.result.group1.miss);
            const g1hit = stat(data.result.group1.hit);
            const g2miss = stat(data.result.group2.miss);
            const g2hit = stat(data.result.group2.hit);
            html += `<div class="row mb-3">
                <div class="col-md-6">
                    <div class="group-stat-card p-3 mb-2">
                        <h6><i class='fas fa-layer-group'></i> 组1遗漏/连中</h6>
                        <div class='stat-label'>最大遗漏: <span class='fw-bold text-danger'>${g1miss.max}</span>，平均遗漏: <span class='fw-bold text-primary'>${g1miss.avg}</span></div>
                        <div class='stat-label'>最大连中: <span class='fw-bold text-success'>${g1hit.max}</span>，平均连中: <span class='fw-bold text-primary'>${g1hit.avg}</span></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="group-stat-card p-3 mb-2">
                        <h6><i class='fas fa-layer-group'></i> 组2遗漏/连中</h6>
                        <div class='stat-label'>最大遗漏: <span class='fw-bold text-danger'>${g2miss.max}</span>，平均遗漏: <span class='fw-bold text-primary'>${g2miss.avg}</span></div>
                        <div class='stat-label'>最大连中: <span class='fw-bold text-success'>${g2hit.max}</span>，平均连中: <span class='fw-bold text-primary'>${g2hit.avg}</span></div>
                    </div>
                </div>
            </div>`;
            html += `<div class='combinations-divider'></div>`;
            // 明细表格美化
            let missPage = 1;
            const missPageSize = 20;
            let detailRows = data.detail_rows || [];
            detailRows = detailRows.slice().reverse(); // 倒序显示
            function renderDetailTable(page, rows) {
                if (!rows || rows.length === 0) {
                    document.getElementById('missDetailTable').innerHTML = '<div class="text-center text-muted py-4">暂无明细数据</div>';
                    return;
                }
                let html = '<div class="miss-detail-table-wrap">';
                html += '<div class="table-responsive">';
                html += '<table class="table table-bordered table-sm table-hover">';
                html += '<thead class="table-dark"><tr>' +
                    '<th>期数</th><th>开奖时间</th><th>第N个码</th><th>所属组别</th>' +
                    '<th>组1连续命中</th><th>组2连续命中</th><th>组1连续遗漏</th><th>组2连续遗漏</th>' +
                    '</tr></thead><tbody>';
                const start = (page-1)*missPageSize;
                const end = Math.min(start+missPageSize, rows.length);
                for(let i=start;i<end;i++){
                    const r = rows[i];
                    html += `<tr>`;
                    html += `<td>${r.qishu}</td>`;
                    html += `<td>${r.draw_time}</td>`;
                    html += `<td>${r.number}</td>`;
                    html += `<td>${r.group===1?'组1':r.group===2?'组2':'其它'}</td>`;
                    html += `<td>${r.g1_hit}</td>`;
                    html += `<td>${r.g2_hit}</td>`;
                    html += `<td>${r.g1_miss}</td>`;
                    html += `<td>${r.g2_miss}</td>`;
                    html += `</tr>`;
                }
                html += '</tbody></table></div>';
                // 分页按钮
                html += `<div class='d-flex justify-content-between align-items-center my-2'>`;
                html += `<button class='btn btn-sm btn-outline-primary' style='border-radius:6px;' ${page<=1?'disabled':''} onclick='missPageChange(-1)'><i class='fas fa-chevron-left'></i> 上一页</button>`;
                html += `<span>第 ${page} / ${Math.ceil(rows.length/missPageSize)} 页</span>`;
                html += `<button class='btn btn-sm btn-outline-primary' style='border-radius:6px;' ${end>=rows.length?'disabled':''} onclick='missPageChange(1)'>下一页 <i class='fas fa-chevron-right'></i></button>`;
                html += `</div></div>`;
                document.getElementById('missDetailTable').innerHTML = html;
            }
            window.missPageChange = function(delta) {
                missPage += delta;
                if (missPage < 1) missPage = 1;
                if (missPage > Math.ceil(detailRows.length/missPageSize)) missPage = Math.ceil(detailRows.length/missPageSize);
                renderDetailTable(missPage, detailRows);
            }
            // 渲染明细表格入口
            html += `<div class='mt-3 d-flex justify-content-between align-items-center'>`;
            html += `<strong>期数明细表</strong>`;
            html += `<button class='btn btn-sm' id='exportDetailCSVBtn'><i class='fas fa-download'></i> 导出全部明细</button>`;
            html += `</div><div id='missDetailTable'></div>`;
            missPage = 1;
            setTimeout(()=>renderDetailTable(missPage, detailRows), 0);

            container.innerHTML = html;
            // 绑定导出按钮事件
            setTimeout(()=>{
                const btn = document.getElementById('exportDetailCSVBtn');
                if(btn){
                    btn.onclick = function(){
                        exportDetailCSV(detailRows);
                    };
                }
            }, 0);
        }

        // 加载开奖数据
        async function loadData() {
            try {
                const limit = document.getElementById('dataLimit').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let url = `/api/data?limit=${limit}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayDataTable(result.data);
                } else {
                    document.getElementById('dataTable').innerHTML = '<div class="error">没有找到数据</div>';
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                document.getElementById('dataTable').innerHTML = '<div class="error">加载数据失败</div>';
            }
        }

        // 显示数据表格
        function displayDataTable(data) {
            // 按年份分组
            const grouped = {};
            data.forEach(item => {
                const year = item.qishu ? item.qishu.substring(0, 4) : '未知';
                if (!grouped[year]) grouped[year] = [];
                grouped[year].push(item);
            });

            // 按年份倒序排列
            const years = Object.keys(grouped).sort((a, b) => b.localeCompare(a));

            let html = '';
            years.forEach(year => {
                // 每年内按期数倒序排列
                grouped[year].sort((a, b) => b.qishu.localeCompare(a.qishu));
                html += `<h5 class="mt-4 mb-2">${year} 年</h5>`;
                html += '<div class="table-responsive"><table class="table table-striped">';
                html += '<thead><tr><th>期数</th><th>开奖时间</th><th>开奖号码</th><th>创建时间</th><th>备注</th></tr></thead><tbody>';
                grouped[year].forEach(item => {
                    html += '<tr>';
                    html += `<td>${item.qishu}</td>`;
                    html += `<td>${item.draw_time}</td>`;
                    html += '<td>';
                    item.numbers.forEach(num => {
                        html += createNumberBall(num);
                    });
                    html += '</td>';
                    html += `<td>${item.created_at}</td>`;
                    html += `<td>${item.remark || '-'}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
            });
            document.getElementById('dataTable').innerHTML = html;
        }

        // 渲染遗漏区段表格
        function renderMissTable(groupIndex, missData) {
            const container = document.getElementById(`group${groupIndex}MissTable`);
            if (!missData || missData.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">暂无遗漏数据</div>';
                return;
            }

            let html = '<div class="table-responsive">';
            html += '<table class="table table-bordered table-sm table-hover">';
            html += '<thead class="table-dark"><tr><th>遗漏期数</th><th>遗漏次数</th></tr></thead><tbody>';
            
            missData.forEach(item => {
                html += `<tr>`;
                html += `<td>${item.miss_period}</td>`;
                html += `<td>${item.miss_count}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // 导出遗漏数据为CSV
        function exportMissCSV(groupIndex) {
            const missData = currentData.combinationsDetails.result.group1.miss || []; // 假设遗漏数据在combinationsDetails中
            const filename = `遗漏数据_组${groupIndex}.csv`;
            const csvContent = "遗漏期数,遗漏次数\n" + missData.map(item => `${item.miss_period},${item.miss_count}`).join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 导出明细表格为CSV
        function exportDetailCSV(rows) {
            if (!rows || rows.length === 0) {
                alert('暂无明细数据可导出');
                return;
            }
            const header = ['期数','开奖时间','第N个码','所属组别','组1连续命中','组2连续命中','组1连续遗漏','组2连续遗漏'];
            const csvRows = [header.join(',')];
            rows.forEach(r => {
                csvRows.push([
                    r.qishu,
                    r.draw_time,
                    r.number,
                    r.group===1?'组1':r.group===2?'组2':'其它',
                    r.g1_hit,
                    r.g2_hit,
                    r.g1_miss,
                    r.g2_miss
                ].join(','));
            });
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '组合分析明细.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 前6码±1推荐分析
        let sixpmSelectedYear = 'all';
        let sixpmSelectedN = 1;
        let sixpmMaxMissMap = {};
        async function loadSixPlusMinusAnalysis() {
            const threshold = parseInt(document.getElementById('sixpm-threshold').value || '10', 10);
            const year = sixpmSelectedYear || 'all';
            const plusminus = sixpmSelectedN || 1;
            document.getElementById('sixpm-stats').innerHTML = '<div class="loading">加载中...</div>';
            document.getElementById('sixpm-table').innerHTML = '';
            try {
                const response = await fetch(`/api/sixplusminus-analysis?threshold=${threshold}&year=${year}&plusminus=${plusminus}`);
                const result = await response.json();
                if (result.success) {
                    window.sixpmLastData = result.data;
                    renderSixPlusMinusStats(result.data);
                    renderSixPlusMinusTable(result.data);
                    // 更新当前N的最大遗漏
                    if (window.sixpmLastData && typeof window.sixpmLastData.max_miss === 'number') {
                        sixpmMaxMissMap[sixpmSelectedN] = window.sixpmLastData.max_miss;
                    }
                    fillSixpmNOptions();
                } else {
                    document.getElementById('sixpm-stats').innerHTML = '<div class="error">' + (result.error || '加载失败') + '</div>';
                }
            } catch (e) {
                document.getElementById('sixpm-stats').innerHTML = '<div class="error">加载失败</div>';
            }
        }
        function renderSixPlusMinusStats(data) {
            let html = '';
            html += `<div class='mb-2'><strong>最大遗漏：</strong><span class='text-danger fw-bold'>${data.max_miss}</span>  <strong>当前遗漏：</strong><span class='text-primary fw-bold'>${data.current_miss}</span>  <span class='ms-3 text-secondary'>当前分析：前6码±${data.plusminus}</span></div>`;
            if (data.latest_plusminus && data.latest_plusminus.length > 0) {
                html += '<div class="mb-2">';
                if (data.latest_six && data.latest_six.length === 6) {
                    html += '本期6码：';
                    data.latest_six.forEach(num => {
                        const colorClass = getNumberColorClass(num);
                        html += `<span class="lottery-number ${colorClass}" style="width:28px;height:28px;line-height:28px;font-size:14px;margin:0 2px;">${num}</span>`;
                    });
                    html += '<br />';
                }
                html += '最新一期12码推荐：';
                data.latest_plusminus.forEach(num => {
                    const colorClass = getNumberColorClass(num);
                    const highlight = (data.highlight && data.highlight.includes(num)) ? 'background:#d9534f;color:#fff;font-weight:bold;' : '';
                    html += `<span class="lottery-number ${colorClass}" style="width:32px;height:32px;line-height:32px;font-size:15px;margin:0 3px;${highlight}">${num}</span>`;
                });
                html += '</div>';
            }
            document.getElementById('sixpm-stats').innerHTML = html;
        }
        function renderSixPlusMinusTable(data) {
            const rows = data.detail_rows || [];
            if (!rows.length) {
                document.getElementById('sixpm-table').innerHTML = '<div class="text-center text-muted py-4">暂无明细数据</div>';
                return;
            }
            let html = '<div class="miss-detail-table-wrap">';
            html += '<div class="table-responsive">';
            html += '<table class="table table-bordered table-sm table-hover">';
            html += '<thead class="table-dark"><tr>' +
                '<th>期数</th><th>开奖时间</th><th>12码推荐</th><th>第7码</th><th>命中</th><th>遗漏期数</th>' +
                '</tr></thead><tbody>';
            rows.slice().reverse().forEach(r => {
                // 高亮样式设置在遗漏期数列
                let highlightMiss = (r.miss_streak >= (data.threshold||10) && r.is_hit===false) ? 'background:#d9534f;color:#fff;font-weight:bold;' : '';
                html += `<tr>`;
                html += `<td>${r.qishu}</td>`;
                html += `<td>${r.draw_time}</td>`;
                html += `<td>`;
                (r.plusminus12||[]).forEach(num => {
                    const colorClass = getNumberColorClass(num);
                    html += `<span class="lottery-number ${colorClass}" style="width:24px;height:24px;line-height:24px;font-size:13px;margin:0 1px;">${num}</span>`;
                });
                html += `</td>`;
                html += `<td>${r.seventh||''}</td>`;
                html += `<td>${r.is_hit===true ? '命中' : (r.is_hit===false ? '遗漏' : '')}</td>`;
                html += `<td style='${highlightMiss}'>${r.miss_streak ? `连续${r.miss_streak}期未中奖` : ''}</td>`;
                html += `</tr>`;
            });
            html += '</tbody></table></div></div>';
            document.getElementById('sixpm-table').innerHTML = html;
        }
        // 前6码±1推荐分析
        async function fillSixpmYearOptions() {
            try {
                const response = await fetch('/api/data?limit=10000');
                const result = await response.json();
                if (result.success) {
                    const years = new Set();
                    (result.data||[]).forEach(item => {
                        if(item.qishu && item.qishu.length>=4) years.add(item.qishu.slice(0,4));
                    });
                    const yearArr = Array.from(years).sort((a,b)=>b.localeCompare(a));
                    const btns = ['<button type="button" class="btn btn-outline-primary btn-sm me-1" data-year="all">全部</button>'];
                    yearArr.forEach(y => {
                        btns.push(`<button type="button" class="btn btn-outline-primary btn-sm me-1" data-year="${y}">${y}</button>`);
                    });
                    document.getElementById('sixpm-year-btns').innerHTML = btns.join('');
                    // 绑定点击事件
                    document.querySelectorAll('#sixpm-year-btns button').forEach(btn => {
                        btn.onclick = function() {
                            sixpmSelectedYear = this.getAttribute('data-year');
                            document.querySelectorAll('#sixpm-year-btns button').forEach(b=>b.classList.remove('active'));
                            this.classList.add('active');
                            loadSixPlusMinusAnalysis();
                        };
                    });
                    // 默认选中全部
                    document.querySelector('#sixpm-year-btns button[data-year="all"]').classList.add('active');
                }
            } catch(e) {console.error('年份选项加载失败',e);}
        }
        document.addEventListener('DOMContentLoaded', function() {
            fillSixpmYearOptions();
        });

        let sixpmCurrentMissMap = {};
        function fillSixpmNOptions() {
            const btns = [];
            for(let n=1;n<=10;n++) {
                let miss = sixpmCurrentMissMap[n] !== undefined ? `(${sixpmCurrentMissMap[n]})` : '';
                btns.push(`<button type="button" class="btn btn-outline-secondary btn-sm me-1" data-n="${n}">±${n}${miss}</button>`);
            }
            document.getElementById('sixpm-n-btns').innerHTML = btns.join('');
            document.querySelectorAll('#sixpm-n-btns button').forEach(btn => {
                btn.onclick = function() {
                    sixpmSelectedN = parseInt(this.getAttribute('data-n'));
                    document.querySelectorAll('#sixpm-n-btns button').forEach(b=>b.classList.remove('active'));
                    this.classList.add('active');
                    loadSixPlusMinusAnalysis();
                };
            });
            document.querySelector(`#sixpm-n-btns button[data-n="${sixpmSelectedN}"]`).classList.add('active');
        }
        document.addEventListener('DOMContentLoaded', function() {
            fillSixpmNOptions();
        });

        async function updateSixpmCurrentMissMap() {
            sixpmCurrentMissMap = {};
            const year = sixpmSelectedYear || 'all';
            const threshold = parseInt(document.getElementById('sixpm-threshold').value || '10', 10);
            for(let n=1;n<=10;n++) {
                try {
                    const resp = await fetch(`/api/sixplusminus-analysis?threshold=${threshold}&year=${year}&plusminus=${n}`);
                    const result = await resp.json();
                    if(result.success && result.data && typeof result.data.current_miss === 'number') {
                        sixpmCurrentMissMap[n] = result.data.current_miss;
                    } else {
                        sixpmCurrentMissMap[n] = '-';
                    }
                } catch { sixpmCurrentMissMap[n] = '-'; }
            }
            fillSixpmNOptions();
        }
        document.addEventListener('DOMContentLoaded', function() {
            fillSixpmNOptions();
            updateSixpmCurrentMissMap();
        });

        function exportSixPlusMinusCSV() {
            if (!window.sixpmLastData || !sixpmLastData.detail_rows) {
                alert('暂无可导出的数据');
                return;
            }
            const rows = sixpmLastData.detail_rows;
            let csv = `期数,开奖时间,12码推荐,第7码,命中,遗漏期数,加减范围\n`;
            rows.slice().reverse().forEach(r => {
                const plus12 = (r.plusminus12||[]).join(' ');
                const isHit = r.is_hit===true ? '命中' : (r.is_hit===false ? '遗漏' : '');
                const miss = r.miss_streak ? `连续${r.miss_streak}期未中奖` : '';
                csv += `${r.qishu},${r.draw_time},"${plus12}",${r.seventh||''},${isHit},${miss},±${sixpmSelectedN}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sixplusminus_analysis.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // +1~+20区间分析
        let plus20SelectedYear = 'all';
        async function fillPlus20YearOptions() {
            try {
                const response = await fetch('/api/data?limit=10000');
                const result = await response.json();
                if (result.success) {
                    const years = new Set();
                    (result.data||[]).forEach(item => {
                        if(item.qishu && item.qishu.length>=4) years.add(item.qishu.slice(0,4));
                    });
                    const yearArr = Array.from(years).sort((a,b)=>b.localeCompare(a));
                    const btns = ['<button type="button" class="btn btn-outline-primary btn-sm me-1" data-year="all">全部</button>'];
                    yearArr.forEach(y => {
                        btns.push(`<button type="button" class="btn btn-outline-primary btn-sm me-1" data-year="${y}">${y}</button>`);
                    });
                    document.getElementById('plus20-year-btns').innerHTML = btns.join('');
                    // 绑定点击事件
                    document.querySelectorAll('#plus20-year-btns button').forEach(btn => {
                        btn.onclick = function() {
                            plus20SelectedYear = this.getAttribute('data-year');
                            document.querySelectorAll('#plus20-year-btns button').forEach(b=>b.classList.remove('active'));
                            this.classList.add('active');
                            loadPlus20Intervals();
                        };
                    });
                    // 默认选中全部
                    document.querySelector('#plus20-year-btns button[data-year="all"]').classList.add('active');
                }
            } catch(e) {console.error('年份选项加载失败',e);}
        }
        document.addEventListener('DOMContentLoaded', function() {
            fillPlus20YearOptions();
        });

        let plus20CurrentPage = 1;
        const plus20PageSize = 50;
        let plus20LastData = [];
        let plus20LastMaxMissArr = [];
        let plus20LastCurrentMissArr = [];
        function renderPlus20Table(page, data, maxMissArr, currentMissArr, latestInfo) {
            // 重新计算最大遗漏（基于当前筛选数据）
            let dynamicMaxMissArr = [0,0,0,0,0,0,0];
            for (let i = 0; i < 7; i++) {
                let arr = data.map(row => row.intervals[i]?.miss_streak || 0);
                dynamicMaxMissArr[i] = Math.max(...arr, 0);
            }
            // 最新一期区间预算展示（以API返回的latest_info为准）
            let latestHtml = '';
            if (latestInfo) {
                let maxQishu = parseInt(latestInfo.qishu);
                let showQishu = maxQishu.toString();
                let nextQishu = (maxQishu + 1).toString();
                latestHtml += `<div class='mb-2'><strong>最新一期（${showQishu}）号码及区间，预测下一期期号：${nextQishu}</strong><div class='d-flex flex-wrap align-items-center'>`;
                latestInfo.numbers.forEach((num, idx) => {
                    // 计算区间
                    const start = plus20SelectedRange.start;
                    const end = plus20SelectedRange.end;
                    const rng = [];
                    for(let j=start;j<=end;j++) {
                        rng.push((num + j - 1) % 49 + 1);
                    }
                    const rng_min = rng[0];
                    const rng_max = rng[rng.length-1];
                    latestHtml += `<div class='me-3 mb-1'><span class='lottery-number ${getNumberColorClass(num)}'>${num}</span><div style='font-size:12px;'>区间:${rng_min}~${rng_max}</div></div>`;
                });
                latestHtml += `</div></div>`;
            }
            let statHtml = '<div class="row mb-2">';
            for (let i = 0; i < 7; i++) {
                statHtml += `<div class='col-auto'><div class='card p-2 text-center' style='min-width:90px;'><div class='fw-bold' style='font-size:1.1rem;'>号码${i+1}</div><div>最高遗漏: <span class='text-danger fw-bold'>${dynamicMaxMissArr[i]||0}</span></div><div>当前遗漏: <span class='text-primary fw-bold'>${currentMissArr[i]||0}</span></div></div></div>`;
            }
            statHtml += '</div>';
            let html = latestHtml + statHtml;
            html += '<div class="table-responsive" style="max-height:600px;overflow:auto;">';
            html += '<table class="table table-bordered table-sm table-hover">';
            html += '<thead><tr><th>期数</th><th>开奖时间</th>';
            for (let i = 1; i <= 7; i++) html += `<th>号码${i}</th>`;
            html += '<th>下一期第7码</th></tr></thead><tbody>';
            const start = (page-1)*plus20PageSize;
            const end = Math.min(start+plus20PageSize, data.length);
            for(let idx=start; idx<end; idx++) {
                const row = data[idx];
                html += `<tr><td>${row.qishu}</td><td>${row.draw_time}</td>`;
                row.intervals.forEach((item, i) => {
                    let colorClass = getNumberColorClass(item.number);
                    let hitText = item.hit ? '<span style="color:green;">命中</span>' : '<span style="color:red;">遗漏</span>';
                    let highlightTd = !item.hit && item.miss_streak >= plus20Threshold ? 'background:#d9534f;color:#fff;font-weight:bold;' : '';
                    let missText = !item.hit && item.miss_streak > 0 ? `连续${item.miss_streak}期未命中` : '';
                    html += `<td style='min-width:110px;${highlightTd}'>
                        <span class="lottery-number ${colorClass}">${item.number}</span>
                        <div style='font-size:12px;'>区间:${item.range[0]}~${item.range[1]}</div>
                        <div style='font-size:12px;'>${hitText}</div>
                        <div style='font-size:12px;'>${missText}</div>
                    </td>`;
                });
                html += `<td><span class='lottery-number ${getNumberColorClass(row.next_seventh)}'>${row.next_seventh ?? '-'}</span></td></tr>`;
            }
            html += '</tbody></table></div>';
            // 分页按钮
            html += `<div class='d-flex justify-content-between align-items-center my-2'>`;
            html += `<button class='btn btn-sm btn-outline-primary' style='border-radius:6px;' ${page<=1?'disabled':''} onclick='plus20PageChange(-1)'><i class='fas fa-chevron-left'></i> 上一页</button>`;
            html += `<span>第 ${page} / ${Math.ceil(data.length/plus20PageSize)} 页</span>`;
            html += `<button class='btn btn-sm btn-outline-primary' style='border-radius:6px;' ${end>=data.length?'disabled':''} onclick='plus20PageChange(1)'>下一页 <i class='fas fa-chevron-right'></i></button>`;
            html += `</div>`;
            document.getElementById('plus20Table').innerHTML = html;
        }
        function plus20PageChange(delta) {
            plus20CurrentPage += delta;
            if (plus20CurrentPage < 1) plus20CurrentPage = 1;
            if (plus20CurrentPage > Math.ceil(plus20LastData.length/plus20PageSize)) plus20CurrentPage = Math.ceil(plus20LastData.length/plus20PageSize);
            renderPlus20Table(plus20CurrentPage, plus20LastData, plus20LastMaxMissArr, plus20LastCurrentMissArr, plus20LastData[0]?.latest_info || null);
        }
        let plus20Threshold = 10;
        async function loadPlus20Intervals() {
            plus20Threshold = parseInt(document.getElementById('plus20-threshold').value || '10', 10);
            document.getElementById('plus20Table').innerHTML = '<div class="loading">加载中...</div>';
            try {
                const response = await fetch('/api/plus20-intervals');
                const result = await response.json();
                if (!result.success) {
                    document.getElementById('plus20Table').innerHTML = '<div class="error">没有找到数据</div>';
                    return;
                }
                let data = result.data;
                // 年份筛选
                if (plus20SelectedYear !== 'all') {
                    data = data.filter(row => (row.qishu||'').toString().startsWith(plus20SelectedYear));
                }
                data.reverse();
                // 用API返回的latest_info
                let latestInfo = result.latest_info || null;
                // 统计当前遗漏（每个号码位的当前miss_streak）
                let currentMissArr = [0,0,0,0,0,0,0];
                if (data.length > 0) {
                    let last = data[data.length-1];
                    last.intervals.forEach((item, idx) => {
                        currentMissArr[idx] = item.miss_streak;
                    });
                }
                plus20LastData = data;
                plus20LastMaxMissArr = result.max_miss || [];
                plus20LastCurrentMissArr = currentMissArr;
                plus20CurrentPage = 1;
                renderPlus20Table(plus20CurrentPage, plus20LastData, plus20LastMaxMissArr, plus20LastCurrentMissArr, latestInfo);
            } catch (e) {
                document.getElementById('plus20Table').innerHTML = '<div class="error">加载失败</div>';
            }
        }
        // Tab切换时加载
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(event) {
                const target = event.target.getAttribute('data-bs-target');
                if (target === '#plus20') {
                    loadPlus20Intervals();
                }
            });
        });

        // 区间选择
        let plus20RangeList = [
            {label: '+1~+20', start: 1, end: 20},
            {label: '+5~+25', start: 5, end: 25},
            {label: '+10~+30', start: 10, end: 30},
            {label: '+15~+35', start: 15, end: 35},
            {label: '+20~+40', start: 20, end: 40},
            {label: '+25~+45', start: 25, end: 45}
        ];
        let plus20SelectedRange = plus20RangeList[0];
        function fillPlus20RangeOptions() {
            const btns = plus20RangeList.map((r,i) => `<button type="button" class="btn btn-outline-success btn-sm me-1" data-range="${i}">${r.label}</button>`);
            document.getElementById('plus20-range-btns').innerHTML = btns.join('');
            document.querySelectorAll('#plus20-range-btns button').forEach(btn => {
                btn.onclick = function() {
                    plus20SelectedRange = plus20RangeList[parseInt(this.getAttribute('data-range'))];
                    document.querySelectorAll('#plus20-range-btns button').forEach(b=>b.classList.remove('active'));
                    this.classList.add('active');
                    loadPlus20Intervals();
                };
            });
            document.querySelector('#plus20-range-btns button[data-range="0"]').classList.add('active');
        }
        document.addEventListener('DOMContentLoaded', function() {
            fillPlus20RangeOptions();
        });
    </script>
</body>
</html> 