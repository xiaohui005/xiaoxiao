<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>彩票开奖数据分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .stats-card .number {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .lottery-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: 50%;
            margin: 2px;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* 鲜红色球 - 1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46 */
        .lottery-number.red {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
        }
        
        /* 绿色球 - 3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48 */
        .lottery-number.green {
            background: linear-gradient(135deg, #2ed573,rgb(24, 228, 24));
            box-shadow: 0 2px 8px rgba(96, 243, 11, 0.91);
        }
        
        /* 暗蓝色球 - 5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49 */
        .lottery-number.blue {
            background: linear-gradient(135deg, #3742fa, #2f3542);
            box-shadow: 0 2px 8px rgba(55, 66, 250, 0.3);
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #667eea;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .frequency-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .frequency-number {
            font-weight: bold;
            color: #667eea;
        }
        
        .frequency-count {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 头部 -->
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> 彩票开奖数据分析系统</h1>
                <p class="text-muted">专业的彩票数据分析和统计平台</p>
            </div>

            <!-- 统计卡片 -->
            <div class="row" id="statsCards">
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3><i class="fas fa-list"></i> 总期数</h3>
                        <div class="number" id="totalCount">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3><i class="fas fa-calendar"></i> 最新开奖</h3>
                        <div class="number" id="latestTime">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3><i class="fas fa-clock"></i> 最早开奖</h3>
                        <div class="number" id="earliestTime">-</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3><i class="fas fa-chart-bar"></i> 数据范围</h3>
                        <div class="number" id="dataRange">-</div>
                    </div>
                </div>
            </div>

            <!-- 导航标签 -->
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-home"></i> 概览
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="frequency-tab" data-bs-toggle="tab" data-bs-target="#frequency" type="button" role="tab">
                        <i class="fas fa-chart-pie"></i> 号码频率
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hotcold-tab" data-bs-toggle="tab" data-bs-target="#hotcold" type="button" role="tab">
                        <i class="fas fa-fire"></i> 冷热号码
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab">
                        <i class="fas fa-trending-up"></i> 趋势分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="combinations-tab" data-bs-toggle="tab" data-bs-target="#combinations" type="button" role="tab">
                        <i class="fas fa-puzzle-piece"></i> 组合分析
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">
                        <i class="fas fa-table"></i> 开奖数据
                    </button>
                </li>
            </ul>

            <!-- 标签内容 -->
            <div class="tab-content" id="mainTabsContent">
                <!-- 概览 -->
                <div class="tab-pane fade" id="overview" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-chart-pie"></i> 号码分布</h4>
                                <canvas id="numberDistributionChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-chart-bar"></i> 奇偶分布</h4>
                                <canvas id="oddEvenChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="chart-container">
                                <h4><i class="fas fa-clock"></i> 最近开奖记录</h4>
                                <div id="recentData"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 号码频率 -->
                <div class="tab-pane fade" id="frequency" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-chart-bar"></i> 号码出现频率 (前20)</h4>
                                <canvas id="frequencyChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-list"></i> 频率详情</h4>
                                <div id="frequencyDetails"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 冷热号码 -->
                <div class="tab-pane fade" id="hotcold" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-fire"></i> 热号 (最近100期)</h4>
                                <canvas id="hotNumbersChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-snowflake"></i> 冷号 (最近100期)</h4>
                                <canvas id="coldNumbersChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 趋势分析 -->
                <div class="tab-pane fade" id="trends" role="tabpanel">
                    <div class="filter-section">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="trendDays" class="form-label">分析天数</label>
                                <select class="form-select" id="trendDays">
                                    <option value="30">最近30期</option>
                                    <option value="50">最近50期</option>
                                    <option value="100">最近100期</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary d-block" onclick="loadTrends()">
                                    <i class="fas fa-sync"></i> 更新趋势
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="chart-container">
                                <h4><i class="fas fa-chart-line"></i> 号码趋势分析</h4>
                                <canvas id="trendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 组合分析 -->
                <div class="tab-pane fade" id="combinations" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-percentage"></i> 组合统计</h4>
                                <canvas id="combinationsChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h4><i class="fas fa-info-circle"></i> 组合详情</h4>
                                <div id="combinationsDetails"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 开奖数据 -->
                <div class="tab-pane fade show active" id="data" role="tabpanel">
                    <div class="filter-section">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="dataLimit" class="form-label">显示条数</label>
                                <select class="form-select" id="dataLimit">
                                    <option value="50">50条</option>
                                    <option value="100">100条</option>
                                    <option value="200">200条</option>
                                    <option value="500">500条</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="startDate" class="form-label">开始日期</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-3">
                                <label for="endDate" class="form-label">结束日期</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary d-block" onclick="loadData()">
                                    <i class="fas fa-search"></i> 查询数据
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="data-table">
                        <h4><i class="fas fa-table"></i> 开奖数据列表</h4>
                        <div id="dataTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let charts = {};
        let currentData = {};

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadData(); // 默认加载开奖数据
        });

        // 加载统计数据
        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('totalCount').textContent = data.total_count || 0;
                    document.getElementById('latestTime').textContent = data.latest_time ? new Date(data.latest_time).toLocaleDateString() : '-';
                    document.getElementById('earliestTime').textContent = data.earliest_time ? new Date(data.earliest_time).toLocaleDateString() : '-';
                    
                    if (data.latest_time && data.earliest_time) {
                        const days = Math.ceil((new Date(data.latest_time) - new Date(data.earliest_time)) / (1000 * 60 * 60 * 24));
                        document.getElementById('dataRange').textContent = days + '天';
                    }
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载概览数据
        async function loadOverview() {
            try {
                const response = await fetch('/api/analysis');
                const result = await response.json();
                
                if (result.success) {
                    currentData.analysis = result.data;
                    createOverviewCharts();
                }
            } catch (error) {
                console.error('加载概览数据失败:', error);
            }
        }

        // 创建概览图表
        function createOverviewCharts() {
            const analysis = currentData.analysis;
            if (!analysis) return;

            // 号码分布图
            const distributionCtx = document.getElementById('numberDistributionChart').getContext('2d');
            if (charts.numberDistribution) {
                charts.numberDistribution.destroy();
            }
            
            const frequencyData = analysis.frequency?.frequency || {};
            const labels = Object.keys(frequencyData).slice(0, 20);
            const data = labels.map(key => frequencyData[key]);
            
            // 根据号码设置颜色
            const colors = labels.map(num => {
                const colorClass = getNumberColorClass(parseInt(num));
                if (colorClass === 'red') return 'rgba(255, 71, 87, 0.8)';
                if (colorClass === 'green') return 'rgba(46, 213, 115, 0.8)';
                if (colorClass === 'blue') return 'rgba(55, 66, 250, 0.8)';
                return 'rgba(102, 126, 234, 0.8)'; // 默认颜色
            });
            
            charts.numberDistribution = new Chart(distributionCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '出现次数',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 奇偶分布图
            const oddEvenCtx = document.getElementById('oddEvenChart').getContext('2d');
            if (charts.oddEven) {
                charts.oddEven.destroy();
            }
            
            const oddEvenData = analysis.analysis?.odd_even || {};
            const oddCount = Object.values(oddEvenData).reduce((sum, item) => sum + item.odd, 0);
            const evenCount = Object.values(oddEvenData).reduce((sum, item) => sum + item.even, 0);
            
            charts.oddEven = new Chart(oddEvenCtx, {
                type: 'doughnut',
                data: {
                    labels: ['奇数', '偶数'],
                    datasets: [{
                        data: [oddCount, evenCount],
                        backgroundColor: ['#ff6b6b', '#4ecdc4'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 获取号码的颜色类
        function getNumberColorClass(num) {
            const redNumbers = [1,2,7,8,12,13,18,19,23,24,29,30,34,35,40,45,46];
            const greenNumbers = [3,4,9,10,14,15,20,25,26,31,36,37,41,42,47,48];
            const blueNumbers = [5,6,11,16,17,21,22,27,28,32,33,38,39,43,44,49];
            
            if (redNumbers.includes(num)) {
                return 'red';
            } else if (greenNumbers.includes(num)) {
                return 'green';
            } else if (blueNumbers.includes(num)) {
                return 'blue';
            } else {
                return ''; // 默认颜色
            }
        }

        // 创建带颜色的号码球HTML
        function createNumberBall(num) {
            const colorClass = getNumberColorClass(num);
            return `<span class="lottery-number ${colorClass}">${num}</span>`;
        }

        // 加载最近开奖数据
        async function loadRecentData() {
            try {
                const response = await fetch('/api/recent');
                const result = await response.json();
                
                if (result.success) {
                    displayRecentData(result.data);
                }
            } catch (error) {
                console.error('加载最近数据失败:', error);
            }
        }

        // 显示最近开奖数据
        function displayRecentData(data) {
            const container = document.getElementById('recentData');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">暂无开奖数据</div>';
                return;
            }
            
            let html = '<div class="table-responsive">';
            html += '<table class="table table-hover">';
            html += '<thead class="table-dark"><tr><th>期数</th><th>开奖时间</th><th>开奖号码</th></tr></thead><tbody>';
            
            data.forEach((item, index) => {
                const rowClass = index === 0 ? 'table-warning' : '';
                html += `<tr class="${rowClass}">`;
                html += `<td><strong>${item.qishu}</strong></td>`;
                html += `<td>${item.draw_time}</td>`;
                html += '<td>';
                item.numbers.forEach(num => {
                    html += createNumberBall(num);
                });
                html += '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            // 添加说明文字
            html += '<div class="mt-3">';
            html += '<div class="row text-center">';
            html += '<div class="col-md-4"><span class="lottery-number red" style="width: 25px; height: 25px; line-height: 25px; font-size: 12px;">1</span> 鲜红色球</div>';
            html += '<div class="col-md-4"><span class="lottery-number green" style="width: 25px; height: 25px; line-height: 25px; font-size: 12px;">3</span> 绿色球</div>';
            html += '<div class="col-md-4"><span class="lottery-number blue" style="width: 25px; height: 25px; line-height: 25px; font-size: 12px;">5</span> 暗蓝色球</div>';
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // 标签切换事件
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(event) {
                const target = event.target.getAttribute('data-bs-target');
                
                switch(target) {
                    case '#overview':
                        loadOverview();
                        loadRecentData();
                        break;
                    case '#frequency':
                        loadFrequency();
                        break;
                    case '#hotcold':
                        loadHotCold();
                        break;
                    case '#trends':
                        loadTrends();
                        break;
                    case '#combinations':
                        loadCombinations();
                        break;
                    case '#data':
                        loadData();
                        break;
                }
            });
        });

        // 加载频率数据
        async function loadFrequency() {
            try {
                const response = await fetch('/api/frequency');
                const result = await response.json();
                
                if (result.success) {
                    createFrequencyCharts(result.data);
                    displayFrequencyDetails(result.data);
                }
            } catch (error) {
                console.error('加载频率数据失败:', error);
            }
        }

        // 创建频率图表
        function createFrequencyCharts(data) {
            const frequencyCtx = document.getElementById('frequencyChart').getContext('2d');
            if (charts.frequency) {
                charts.frequency.destroy();
            }
            
            const mostCommon = data.most_common || {};
            const labels = Object.keys(mostCommon);
            const values = Object.values(mostCommon);
            
            // 根据号码设置颜色
            const colors = labels.map(num => {
                const colorClass = getNumberColorClass(parseInt(num));
                if (colorClass === 'red') return 'rgba(255, 71, 87, 0.8)';
                if (colorClass === 'green') return 'rgba(46, 213, 115, 0.8)';
                if (colorClass === 'blue') return 'rgba(55, 66, 250, 0.8)';
                return 'rgba(255, 107, 107, 0.8)'; // 默认红色
            });
            
            charts.frequency = new Chart(frequencyCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '出现次数',
                        data: values,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 显示频率详情
        function displayFrequencyDetails(data) {
            const container = document.getElementById('frequencyDetails');
            const frequency = data.frequency || {};
            
            let html = '<div class="row">';
            html += '<div class="col-md-6"><h5>出现最多</h5>';
            
            Object.entries(frequency).slice(0, 10).forEach(([number, count]) => {
                const colorClass = getNumberColorClass(parseInt(number));
                html += `<div class="frequency-item">
                    <span class="lottery-number ${colorClass}" style="width: 30px; height: 30px; line-height: 30px; font-size: 12px;">${number}</span>
                    <span class="frequency-count">${count}次</span>
                </div>`;
            });
            
            html += '</div><div class="col-md-6"><h5>出现最少</h5>';
            
            Object.entries(frequency).slice(-10).reverse().forEach(([number, count]) => {
                const colorClass = getNumberColorClass(parseInt(number));
                html += `<div class="frequency-item">
                    <span class="lottery-number ${colorClass}" style="width: 30px; height: 30px; line-height: 30px; font-size: 12px;">${number}</span>
                    <span class="frequency-count">${count}次</span>
                </div>`;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        // 加载冷热号码
        async function loadHotCold() {
            try {
                const response = await fetch('/api/hot-cold');
                const result = await response.json();
                
                if (result.success) {
                    createHotColdCharts(result.data);
                }
            } catch (error) {
                console.error('加载冷热号码失败:', error);
            }
        }

        // 创建冷热号码图表
        function createHotColdCharts(data) {
            // 热号图表
            const hotCtx = document.getElementById('hotNumbersChart').getContext('2d');
            if (charts.hotNumbers) {
                charts.hotNumbers.destroy();
            }
            
            const hotNumbers = data.hot_numbers || {};
            const hotLabels = Object.keys(hotNumbers);
            const hotValues = Object.values(hotNumbers);
            
            // 根据号码设置颜色
            const hotColors = hotLabels.map(num => {
                const colorClass = getNumberColorClass(parseInt(num));
                if (colorClass === 'red') return 'rgba(255, 71, 87, 0.8)';
                if (colorClass === 'green') return 'rgba(46, 213, 115, 0.8)';
                if (colorClass === 'blue') return 'rgba(55, 66, 250, 0.8)';
                return 'rgba(255, 107, 107, 0.8)'; // 默认红色
            });
            
            charts.hotNumbers = new Chart(hotCtx, {
                type: 'bar',
                data: {
                    labels: hotLabels,
                    datasets: [{
                        label: '出现次数',
                        data: hotValues,
                        backgroundColor: hotColors,
                        borderColor: hotColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 冷号图表
            const coldCtx = document.getElementById('coldNumbersChart').getContext('2d');
            if (charts.coldNumbers) {
                charts.coldNumbers.destroy();
            }
            
            const coldNumbers = data.cold_numbers || {};
            const coldLabels = Object.keys(coldNumbers);
            const coldValues = Object.values(coldNumbers);
            
            // 根据号码设置颜色
            const coldColors = coldLabels.map(num => {
                const colorClass = getNumberColorClass(parseInt(num));
                if (colorClass === 'red') return 'rgba(255, 71, 87, 0.8)';
                if (colorClass === 'green') return 'rgba(46, 213, 115, 0.8)';
                if (colorClass === 'blue') return 'rgba(55, 66, 250, 0.8)';
                return 'rgba(78, 205, 196, 0.8)'; // 默认青色
            });
            
            charts.coldNumbers = new Chart(coldCtx, {
                type: 'bar',
                data: {
                    labels: coldLabels,
                    datasets: [{
                        label: '出现次数',
                        data: coldValues,
                        backgroundColor: coldColors,
                        borderColor: coldColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 加载趋势分析
        async function loadTrends() {
            try {
                const days = document.getElementById('trendDays').value;
                const response = await fetch(`/api/trends?days=${days}`);
                const result = await response.json();
                
                if (result.success) {
                    createTrendsChart(result.data);
                }
            } catch (error) {
                console.error('加载趋势数据失败:', error);
            }
        }

        // 创建趋势图表
        function createTrendsChart(data) {
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            if (charts.trends) {
                charts.trends.destroy();
            }
            
            const positions = ['number1', 'number2', 'number3', 'number4', 'number5', 'number6', 'number7'];
            const datasets = positions.map((pos, index) => {
                const posData = data[pos] || {};
                return {
                    label: `位置${index + 1}`,
                    data: [posData.mean || 0, posData.median || 0, posData.min || 0, posData.max || 0],
                    backgroundColor: `hsl(${index * 51}, 70%, 60%)`,
                    borderColor: `hsl(${index * 51}, 70%, 50%)`,
                    borderWidth: 2
                };
            });
            
            charts.trends = new Chart(trendsCtx, {
                type: 'radar',
                data: {
                    labels: ['平均值', '中位数', '最小值', '最大值'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // 加载组合分析
        async function loadCombinations() {
            try {
                const response = await fetch('/api/combinations');
                const result = await response.json();
                
                if (result.success) {
                    createCombinationsChart(result.data);
                    displayCombinationsDetails(result.data);
                }
            } catch (error) {
                console.error('加载组合数据失败:', error);
            }
        }

        // 创建组合图表
        function createCombinationsChart(data) {
            const combinationsCtx = document.getElementById('combinationsChart').getContext('2d');
            if (charts.combinations) {
                charts.combinations.destroy();
            }
            
            const consecutivePercentage = data.consecutive_percentage || 0;
            const duplicatePercentage = data.duplicate_percentage || 0;
            const normalPercentage = 100 - consecutivePercentage - duplicatePercentage;
            
            charts.combinations = new Chart(combinationsCtx, {
                type: 'pie',
                data: {
                    labels: ['连续号码', '重复号码', '正常号码'],
                    datasets: [{
                        data: [consecutivePercentage, duplicatePercentage, normalPercentage],
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 显示组合详情
        function displayCombinationsDetails(data) {
            const container = document.getElementById('combinationsDetails');
            
            let html = '<div class="row">';
            html += `<div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">连续号码</h5>
                        <p class="card-text">出现次数: ${data.consecutive_count || 0}</p>
                        <p class="card-text">占比: ${(data.consecutive_percentage || 0).toFixed(2)}%</p>
                    </div>
                </div>
            </div>`;
            
            html += `<div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">重复号码</h5>
                        <p class="card-text">出现次数: ${data.duplicate_count || 0}</p>
                        <p class="card-text">占比: ${(data.duplicate_percentage || 0).toFixed(2)}%</p>
                    </div>
                </div>
            </div>`;
            
            html += '</div>';
            container.innerHTML = html;
        }

        // 加载开奖数据
        async function loadData() {
            try {
                const limit = document.getElementById('dataLimit').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let url = `/api/data?limit=${limit}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    displayDataTable(result.data);
                } else {
                    document.getElementById('dataTable').innerHTML = '<div class="error">没有找到数据</div>';
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                document.getElementById('dataTable').innerHTML = '<div class="error">加载数据失败</div>';
            }
        }

        // 显示数据表格
        function displayDataTable(data) {
            // 按年份分组
            const grouped = {};
            data.forEach(item => {
                const year = item.qishu ? item.qishu.substring(0, 4) : '未知';
                if (!grouped[year]) grouped[year] = [];
                grouped[year].push(item);
            });

            // 按年份倒序排列
            const years = Object.keys(grouped).sort((a, b) => b.localeCompare(a));

            let html = '';
            years.forEach(year => {
                // 每年内按期数倒序排列
                grouped[year].sort((a, b) => b.qishu.localeCompare(a.qishu));
                html += `<h5 class="mt-4 mb-2">${year} 年</h5>`;
                html += '<div class="table-responsive"><table class="table table-striped">';
                html += '<thead><tr><th>期数</th><th>开奖时间</th><th>开奖号码</th><th>创建时间</th><th>备注</th></tr></thead><tbody>';
                grouped[year].forEach(item => {
                    html += '<tr>';
                    html += `<td>${item.qishu}</td>`;
                    html += `<td>${item.draw_time}</td>`;
                    html += '<td>';
                    item.numbers.forEach(num => {
                        html += createNumberBall(num);
                    });
                    html += '</td>';
                    html += `<td>${item.created_at}</td>`;
                    html += `<td>${item.remark || '-'}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
            });
            document.getElementById('dataTable').innerHTML = html;
        }
    </script>
</body>
</html> 